<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Kenryu</title>
  
  <subtitle>hello there.</subtitle>
  <link href="https://kenryu.cc/atom.xml" rel="self"/>
  
  <link href="https://kenryu.cc/"/>
  <updated>2022-08-03T01:55:36.245Z</updated>
  <id>https://kenryu.cc/</id>
  
  <author>
    <name>Kenryu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Amazon Linux 2（AWS）のroot&amp;パスワードのSSHログイン</title>
    <link href="https://kenryu.cc/2022/08/03/Linux/Amazon_Linux_2%EF%BC%88AWS%EF%BC%89%E3%81%AEroot&amp;%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%AESSH%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3/"/>
    <id>https://kenryu.cc/2022/08/03/Linux/Amazon_Linux_2%EF%BC%88AWS%EF%BC%89%E3%81%AEroot&amp;%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%AESSH%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3/</id>
    <published>2022-08-03T01:21:22.000Z</published>
    <updated>2022-08-03T01:55:36.245Z</updated>
    
    <content type="html"><![CDATA[<p>VNC からログインして、<kbd>E</kbd>を押します。<br><img src="/resources/60ef1180c9404fae9955e7419591ae73.png" alt="vncviewer_1143x861_220803.png"></p><p>linux16の行の後ろに<code>rd.break</code>を追記し、<kbd>CTRL</kbd> + <kbd>X</kbd>を押し起動します。<br><img src="/resources/a87ec93a3244470c9c4609bdb8ba6144.png" alt="vncviewer_1143x861_220803_1.png"></p><p>以下のように、rootファイルシステムを操作できる<code>switch_root:/#</code>コンソール画面にたどり着きました。<br><img src="/resources/a2dbd4a1eb5949ef846677664422bb7b.png" alt="vncviewer_1127x772_220803.png"></p><p>以下のコマンドを入力して、パスワードを設定します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount -o remount,rw /sysroot</span><br><span class="line"><span class="built_in">chroot</span> /sysroot</span><br><span class="line">passwd root</span><br></pre></td></tr></table></figure><p><img src="/resources/e142798769e049b8add32705c2fe2da6.png" alt="vncviewer_1127x772_220803_change_passwd.png"></p><p>以下のコマンドを入力して、SeLinuxを設定して、再起動します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">touch /.autorelabel</span><br><span class="line">exit</span><br><span class="line">exit</span><br></pre></td></tr></table></figure><p><img src="/resources/a8aea795b03e455aace65e8b005c17c3.png" alt="vncviewer_1127x772_220803_selinux.png"></p><p>ログイン画面にたどり着きました、rootと先程設定したパスワードを入力して、ログインします。<br><img src="/resources/4c8ff34776b443aa8c82b80ac992bbe1.png" alt="vncviewer_1127x772_220803_login.png"></p><p>OSをrootからログインできるように、<code>/etc/ssh/sshd_config</code> ファイルを以下２か所を編集します。</p><p><img src="/resources/8a23132f267b4149b0efdf4f2f982885.png" alt="vncviewer_1127x772_220803_PermitRootLogin.png"></p><p><img src="/resources/355440df0fbb4062b2558c3fa2c923cd.png" alt="vncviewer_1127x772_220803_PermitPasswdLogin.png"></p><p>以下のコマンドを入力して、<code>/etc/ssh/sshd_config</code> 設定を反映します。そして、OSのIPアドレスを調べます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sshd</span><br><span class="line">hostname -I</span><br></pre></td></tr></table></figure><p><img src="/resources/08fead9e564e441aab1187f72102fb5b.png" alt="vncviewer_1127x772_220803_getIP.png"></p><p>以上の操作で、Amazon Linux のroot のパスワードを設定したので、ssh からログインできる状態になりましたので、ssh からログインしましょう！<br><img src="/resources/f1b7cbe8eaf64ad6bfbcdd9650e9ff37.png" alt="WindowsTerminal_1118x718_220803.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;VNC からログインして、&lt;kbd&gt;E&lt;/kbd&gt;を押します。&lt;br&gt;&lt;img src=&quot;/resources/60ef1180c9404fae9955e7419591ae73.png&quot; alt=&quot;vncviewer_1143x861_220803.png&quot;&gt;&lt;/p&gt;
&lt;p</summary>
      
    
    
    
    <category term="Linux" scheme="https://kenryu.cc/categories/Linux/"/>
    
    
    <category term="linux" scheme="https://kenryu.cc/tags/linux/"/>
    
    <category term="aws" scheme="https://kenryu.cc/tags/aws/"/>
    
  </entry>
  
  <entry>
    <title>LSI Storage Authority (LSA) on Linux</title>
    <link href="https://kenryu.cc/2022/06/30/Storage/LSI_Storage_Authority_(LSA)_on_Linux/"/>
    <id>https://kenryu.cc/2022/06/30/Storage/LSI_Storage_Authority_(LSA)_on_Linux/</id>
    <published>2022-06-30T07:55:45.000Z</published>
    <updated>2022-06-30T08:44:03.320Z</updated>
    
    <content type="html"><![CDATA[<p>[toc]</p><p><img src="/resources/0095ad2ae257418a89d9961bbf3343f3.png" alt="chrome_1346x624_220630.png"></p><h5 id="step0-firewall-and-selinux"><a href="#step0-firewall-and-selinux" class="headerlink" title="step0. firewall and selinux"></a>step0. firewall and selinux</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=2463/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=9000/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><h5 id="step1-From-following-URL-search-your-HBA-controller-and-download-LSA-packages"><a href="#step1-From-following-URL-search-your-HBA-controller-and-download-LSA-packages" class="headerlink" title="step1. From following URL search your HBA controller and download LSA packages"></a>step1. From following URL search your HBA controller and download LSA packages</h5><p><a href="https://www.broadcom.com/products/storage/raid-controllers">https://www.broadcom.com/products/storage/raid-controllers</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip x.x.x.x_LSA_Linux-x64.zip</span><br></pre></td></tr></table></figure><h5 id="step2-Download-and-install-OpenSLP"><a href="#step2-Download-and-install-OpenSLP" class="headerlink" title="step2. Download and install OpenSLP"></a>step2. Download and install OpenSLP</h5><p><a href="http://www.openslp.org/download.html">http://www.openslp.org/download.html</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum groupinstall -y &#x27;Development Tools&#x27;</span><br><span class="line">wget https://jaist.dl.sourceforge.net/project/openslp/2.0.0/2.0.0%20Release/openslp-2.0.0.tar.gz</span><br><span class="line">tar -zxvf openslp-2.0.0.tar.gz</span><br><span class="line">cd openslp-2.0.0/</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">/usr/local/sbin/slpd stop</span><br></pre></td></tr></table></figure><h5 id="step3-Install-LSA"><a href="#step3-Install-LSA" class="headerlink" title="step3. Install LSA"></a>step3. Install LSA</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd x.x.x.x_LSA_Linux-x64/x64/</span><br><span class="line">./install.sh</span><br><span class="line">ln -sf /usr/local/lib/libslp.so.1.0.0 /opt/lsi/LSIStorageAuthority/bin/libslp.so.1</span><br><span class="line">/etc/init.d/LsiSASH restart</span><br></pre></td></tr></table></figure><p><img src="/resources/0ce63fe5c4884710a862af6a0c13eca3.png" alt="chrome_1920x1032_220630 (2.png).png"></p><p><img src="/resources/fb45842d17a9474ba4afcd4215851e8e.png" alt="chrome_1920x955_220630 (2.png).png"></p><p><img src="/resources/1fb96b3b6b20474eb0fe0443942834a0.png" alt="chrome_1920x1032_220630.png"></p><h5 id="Uninstall"><a href="#Uninstall" class="headerlink" title="Uninstall"></a>Uninstall</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/lsi/LSIStorageAuthority/uninstaller.sh</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[toc]&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/resources/0095ad2ae257418a89d9961bbf3343f3.png&quot; alt=&quot;chrome_1346x624_220630.png&quot;&gt;&lt;/p&gt;
&lt;h5 id=&quot;step0-firewall-and-</summary>
      
    
    
    
    <category term="Storage" scheme="https://kenryu.cc/categories/Storage/"/>
    
    
  </entry>
  
  <entry>
    <title>Make Unix terminal beautiful &amp; productive</title>
    <link href="https://kenryu.cc/2022/05/25/Linux/Make_Unix_terminal_beautiful_&amp;_productive/"/>
    <id>https://kenryu.cc/2022/05/25/Linux/Make_Unix_terminal_beautiful_&amp;_productive/</id>
    <published>2022-05-25T04:12:17.000Z</published>
    <updated>2022-07-01T01:10:58.403Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/resources/c64efe2ef23a48c9916d40d47ddedbcb.gif" alt="iShot_0004-06-30_21.30.44.gif"></p><p>First of all, check the activated shell using this command.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo $SHELL</span><br></pre></td></tr></table></figure><p>The below command will display all the available shell.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/shells</span><br></pre></td></tr></table></figure><h2 id="Install-ZSH"><a href="#Install-ZSH" class="headerlink" title="Install ZSH"></a>Install ZSH</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dnf -y install zsh</span><br><span class="line"># If chsh command no found :</span><br><span class="line">dnf -y install util-linux-user</span><br></pre></td></tr></table></figure><h2 id="change-shell"><a href="#change-shell" class="headerlink" title="change shell"></a>change shell</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chsh -s $(which zsh)</span><br></pre></td></tr></table></figure><h2 id="Install-Oh-My-ZSH"><a href="#Install-Oh-My-ZSH" class="headerlink" title="Install Oh-My-ZSH"></a>Install Oh-My-ZSH</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sh -c &quot;$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)&quot;</span><br><span class="line"># or</span><br><span class="line">sh -c &quot;$(wget https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -)&quot;</span><br><span class="line"># or</span><br><span class="line">curl -Lo install.sh https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Install-powerlevle10k-theme"><a href="#Install-powerlevle10k-theme" class="headerlink" title="Install powerlevle10k theme"></a>Install powerlevle10k theme</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ~/oh-my-zsh/themes/powerlevel10k</span><br><span class="line">echo &#x27;source ~/oh-my-zsh/themes/powerlevel10k/powerlevel10k.zsh-theme&#x27; &gt;&gt;~/.zshrc</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Execute <code>vim .zshrc</code> and modify <code>ZSH_THEME=&quot;powerlevel10k/powerlevel10k&quot; </code></p><p><a href="https://github.com/romkatv/powerlevel10k#installation">https://github.com/romkatv/powerlevel10k#installation</a></p><h2 id="Specify-Terminal-Tab-title-on-ZSH"><a href="#Specify-Terminal-Tab-title-on-ZSH" class="headerlink" title="Specify Terminal Tab title on ZSH"></a>Specify Terminal Tab title on ZSH</h2><p>Execute <code>vim .zshrc</code> add following.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># Uncomment the following line to disable auto-setting terminal title.</span><br><span class="line">DISABLE_AUTO_TITLE=&quot;true&quot;</span><br><span class="line"></span><br><span class="line"># To display Hostname😎PWD_Name as title text</span><br><span class="line">HOSTNAME=$(hostname -s)</span><br><span class="line"></span><br><span class="line"># Let zsh launch with the custom title.</span><br><span class="line">window_title=&quot;\033]0;$HOSTNAME😎$&#123;PWD##*/&#125;\007&quot;</span><br><span class="line">echo -ne &quot;$window_title&quot;</span><br><span class="line"># Refresh the custome title when the directory changes. Changed from precmd as it shall suppress the set-title function below</span><br><span class="line">function chpwd () &#123;</span><br><span class="line">window_title=&quot;\033]0;$HOSTNAME😎$&#123;PWD##*/&#125;\007&quot;</span><br><span class="line">echo -ne &quot;$window_title&quot;</span><br><span class="line">&#125;</span><br><span class="line"># Setting your own title text on demand. (Don&#x27;t change dir after setting it 😎)</span><br><span class="line">function set-title()&#123;</span><br><span class="line">TITLE=&quot;\[\e]2;$*\a\]&quot;</span><br><span class="line">echo -e $&#123;TITLE&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/resources/c64efe2ef23a48c9916d40d47ddedbcb.gif&quot; alt=&quot;iShot_0004-06-30_21.30.44.gif&quot;&gt;&lt;/p&gt;
&lt;p&gt;First of all, check the activated </summary>
      
    
    
    
    <category term="Linux" scheme="https://kenryu.cc/categories/Linux/"/>
    
    
  </entry>
  
  <entry>
    <title>Windows11 の「Num Lock」キーを無効化</title>
    <link href="https://kenryu.cc/2022/05/20/Windows/Windows11_%E3%81%AE%E3%80%8CNum_Lock%E3%80%8D%E3%82%AD%E3%83%BC%E3%82%92%E7%84%A1%E5%8A%B9%E5%8C%96/"/>
    <id>https://kenryu.cc/2022/05/20/Windows/Windows11_%E3%81%AE%E3%80%8CNum_Lock%E3%80%8D%E3%82%AD%E3%83%BC%E3%82%92%E7%84%A1%E5%8A%B9%E5%8C%96/</id>
    <published>2022-05-20T08:02:05.000Z</published>
    <updated>2022-07-01T04:45:16.889Z</updated>
    
    <content type="html"><![CDATA[<h2 id="課題"><a href="#課題" class="headerlink" title="課題"></a>課題</h2><p>ネットワークエンジニアはIPアドレスの入力するなどにテンキーを重宝します。しかし、タイピングするときに間違えて<kbd>Num Lock</kbd>キーを押してしまったら、次に数字を打ちたいのにカーソルが操作されてしまい、若干苛立たしくなるのではないでしょうか？生産性にはともかく、心身の健康にも悪影響を及ぼします。</p><p>ところで、今回は、<kbd>Num Lock</kbd>キーを半永久的に無効化する方法をご紹介致したいと思います。</p><blockquote><p>【永久的】：物理的にキーボードから「Num Lock」キーを取り外し</p></blockquote><p><img src="/resources/1c11b9c1ed07489dae49c0e7d016a5cd.png" alt="chrome_1505x521_220701.png"></p><h2 id="解決方法"><a href="#解決方法" class="headerlink" title="解決方法"></a>解決方法</h2><ol><li><p><kbd>Win</kbd>+<kbd>R</kbd>を同時に押して、<code>regedit</code>　と入力し、「レジストリ エディター」を開きます。　<br><img src="/resources/42353ad6d2a34de89a552598c2093117.png" alt="explorer_456x272_220701.png"></p></li><li><p>アドレスバーに<code>コンピューター\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Keyboard Layout</code>と入力します。<br><img src="/resources/d1da1be4dfc44d2f946d714940015859.png" alt="regedit_1155x509_220701.png"></p></li><li><p>新しいバイナリエディタ<code>Scancode Map</code><br><img src="/resources/4f001eb6e94e4d57aa5ab4a1c3e6663d.png" alt="regedit_1065x423_220701.png"></p></li><li><p>ダブルチェックして以下のように編集します。</p><blockquote><p>注意：Num Lockロックしているかをご確認ください。</p></blockquote><p><img src="/resources/b6b505c4d3984ad086836b911f800778.png" alt="regedit_617x387_220701.png"></p></li><li><p>再起動して完了です。</p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;課題&quot;&gt;&lt;a href=&quot;#課題&quot; class=&quot;headerlink&quot; title=&quot;課題&quot;&gt;&lt;/a&gt;課題&lt;/h2&gt;&lt;p&gt;ネットワークエンジニアはIPアドレスの入力するなどにテンキーを重宝します。しかし、タイピングするときに間違えて&lt;kbd&gt;Num Lock&lt;/</summary>
      
    
    
    
    <category term="Windows" scheme="https://kenryu.cc/categories/Windows/"/>
    
    
    <category term="windows" scheme="https://kenryu.cc/tags/windows/"/>
    
  </entry>
  
  <entry>
    <title>Postfix Dovecot MySQL Mail Server</title>
    <link href="https://kenryu.cc/2022/05/02/Linux/Mail-Server/Postfix-Dovecot-MySQL-Mail-Server/"/>
    <id>https://kenryu.cc/2022/05/02/Linux/Mail-Server/Postfix-Dovecot-MySQL-Mail-Server/</id>
    <published>2022-05-01T15:00:00.000Z</published>
    <updated>2022-06-30T00:45:55.820Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Objective"><a href="#Objective" class="headerlink" title="Objective"></a>Objective</h1><ul><li>Local network (web)mail server.</li><li>Local private PKI.</li><li>On LNMP-base use Postfix &amp; Dovecot &amp; PostfixAdmin &amp; RoundCube.</li></ul><table><thead><tr><th>Name</th><th>Version</th><th>Command</th></tr></thead><tbody><tr><td>Linux</td><td>Rocky Linux release 8.5 (Green Obsidian)</td><td>cat &#x2F;etc&#x2F;centos-release &#x2F;etc&#x2F;os-release &#x2F;etc&#x2F;redhat-release &#x2F;etc&#x2F;rocky-release &#x2F;etc&#x2F;system-release</td></tr><tr><td>Nginx</td><td>nginx version: nginx&#x2F;1.20.2</td><td>nginx -v</td></tr><tr><td>MySQL</td><td>mysql Ver 8.0.28 for Linux on x86_64 (MySQL Community Server - GPL)</td><td>mysql –version</td></tr><tr><td>PHP</td><td>PHP 7.4.29 (fpm-fcgi) (built: Apr 12 2022 10:55:38)</td><td>php -v</td></tr><tr><td>Postfix</td><td>mail_version &#x3D; 3.5.8</td><td>postconf mail_version</td></tr><tr><td>Dovecot</td><td>2.3.8 (9df20d2db)</td><td>dovecot –version</td></tr><tr><td>PostfixAdmin</td><td>3.3.11</td><td></td></tr><tr><td>Roundcube</td><td>1.5.2</td><td></td></tr></tbody></table><h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><ul><li>Have a host with CPU more than 1Core and Memory higher than 2GB.</li><li>Have an LNMP-Base or LAMP-Base host;</li><li>Have an FQDN that can be resolved;</li><li>Have private CA root certificate, Host’s private key, Host’s certificate;</li></ul><p><code>free</code> command</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># free -h</span><br><span class="line">total used free shared buff/cache available</span><br><span class="line">Mem: 1.9Gi 624Mi 746Mi 20Mi 606Mi 1.2Gi</span><br><span class="line">Swap: 2.0Gi 0B 2.0Gi</span><br></pre></td></tr></table></figure><p>DNS Record on name server:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mail.example.com. IN A 192.168.65.132</span><br><span class="line">132.65 IN PTR mail.example.com.</span><br></pre></td></tr></table></figure><p>SSL&#x2F;TSL’s private key and certificate file is following path :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@email ~]# ll /etc/pki/tls/certs/mail.example.com.crt</span><br><span class="line">-r--r--r-- 1 root root 5439 Apr 23 16:41 /etc/pki/tls/certs/mail.example.com.crt</span><br><span class="line">[root@email ~]#</span><br><span class="line">[root@email ~]# ll /etc/pki/tls/private/mail.example.com.key</span><br><span class="line">-r-------- 1 root root 1704 Apr 23 16:41 /etc/pki/tls/private/mail.example.com.key</span><br></pre></td></tr></table></figure><h1 id="Step1-OS-Setting"><a href="#Step1-OS-Setting" class="headerlink" title="Step1. OS Setting"></a>Step1. OS Setting</h1><p>Setting hostname.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># dnf -y update</span><br><span class="line"># hostnamectl set-hostname mail.example.com</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/hosts</span><br><span class="line">127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 mail.example.com</span><br><span class="line">::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 mail.example.com</span><br></pre></td></tr></table></figure><p>Disable SELinux</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># sed -i s/^SELINUX=.*$/SELINUX=disabled/ /etc/selinux/config</span><br><span class="line"># reboot</span><br></pre></td></tr></table></figure><p>Allow the following packages to pass though the firewall.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --permanent --add-service=&#123;http,https,smtp,smtp-submission,smtps,imap,imaps,pop3,pop3s&#125;</span><br><span class="line"># firewall-cmd --reload</span><br><span class="line"># firewall-cmd --list-all</span><br></pre></td></tr></table></figure><p>Install some required packages and recommended PHP modules.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># dnf -y install vim wget tar git nmap bind-utils telnet mailx openssl</span><br><span class="line"># dnf -y install php php-fpm php-imap php-mbstring php-mysqlnd php-gd php-opcache php-json php-curl php-zip php-xml php-bz2 php-intl php-gmp</span><br></pre></td></tr></table></figure><h1 id="Step2-Create-Databases"><a href="#Step2-Create-Databases" class="headerlink" title="Step2. Create Databases"></a>Step2. Create Databases</h1><p>Create a database for PostfixAdmin.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE postfixadmin;</span><br><span class="line">mysql&gt; CREATE USER &#x27;postfixadmin&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;YourPassword&#x27;;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON `postfixadmin` . _config.landscape.yml _config.yml db.json Get_Joplin_resources.sh i18n Install_JavaScripts_via_npm.sh node_modules package.json package-lock.json public scaffolds source symlink.sh test.md themes tmp.md TO &#x27;postfixadmin&#x27;@&#x27;localhost&#x27;;</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><p>Create a database for roundcubu.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE roundcube DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br><span class="line">mysql&gt; CREATE USER roundcube@localhost IDENTIFIED BY &#x27;YourPassword&#x27;;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON roundcube.* TO roundcube@localhost;</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><h1 id="Step3-Create-Web-Servers"><a href="#Step3-Create-Web-Servers" class="headerlink" title="Step3. Create Web Servers"></a>Step3. Create Web Servers</h1><p>Create Nginx config file for PostfixAdmin and RoundCube.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/nginx/conf.d/mail.example.com.conf</span><br><span class="line"># Redirect http to https.</span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">listen [::]:80;</span><br><span class="line">server_name mail.example.com, 192.168.65.132;</span><br><span class="line">return 301 https://mail.example.com$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Listen https://mail.example.com</span><br><span class="line">server &#123;</span><br><span class="line">listen 443 ssl http2;</span><br><span class="line">server_name mail.example.com;</span><br><span class="line"></span><br><span class="line"># SSl/TLS configuration</span><br><span class="line">ssl_certificate &quot;/etc/pki/tls/certs/mail.example.com.crt&quot;;</span><br><span class="line">ssl_certificate_key &quot;/etc/pki/tls/private/mail.example.com.key&quot;;</span><br><span class="line">ssl_session_cache shared:SSL:1m;</span><br><span class="line">ssl_session_timeout 10m;</span><br><span class="line">ssl_ciphers PROFILE=SYSTEM;</span><br><span class="line">ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line"># Roundcube configuration</span><br><span class="line">root /usr/share/nginx/roundcube/;</span><br><span class="line">index index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line"># Roundcube logs</span><br><span class="line">error_log /var/log/nginx/roundcube.error;</span><br><span class="line">access_log /var/log/nginx/roundcube.access;</span><br><span class="line"></span><br><span class="line"># Roundcube Locations</span><br><span class="line">location / &#123;</span><br><span class="line">try_files $uri $uri/ /index.php;</span><br><span class="line">&#125;</span><br><span class="line">location ~ .php$ &#123;</span><br><span class="line">try_files $uri =404;</span><br><span class="line">fastcgi_pass unix:/run/php-fpm/www.sock;</span><br><span class="line">fastcgi_index index.php;</span><br><span class="line">fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">include fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line">location ~ /.well-known/acme-challenge &#123;</span><br><span class="line">allow all;</span><br><span class="line">&#125;</span><br><span class="line">location ~ ^/(README|INSTALL|LICENSE|CHANGELOG|UPGRADING)$ &#123;</span><br><span class="line">deny all;</span><br><span class="line">&#125;</span><br><span class="line">location ~ ^/(bin|SQL)/ &#123;</span><br><span class="line">deny all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Sub-Location of PostfixAdmin</span><br><span class="line">location /postfixadmin &#123;</span><br><span class="line">alias /usr/share/nginx/postfixadmin/public;</span><br><span class="line">access_log /var/log/nginx/postfixadmin_access.log;</span><br><span class="line">error_log /var/log/nginx/postfixadmin_error.log;</span><br><span class="line">try_files $uri $uri/ /index.php;</span><br><span class="line"></span><br><span class="line">location ~ ^/(.+.php)$ &#123;</span><br><span class="line">try_files $uri =404;</span><br><span class="line">fastcgi_pass unix:/run/php-fpm/www.sock;</span><br><span class="line">fastcgi_index index.php;</span><br><span class="line">fastcgi_param SCRIPT_FILENAME $request_filename;</span><br><span class="line">include /etc/nginx/fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># A long browser cache lifetime can speed up repeat visits to your page</span><br><span class="line"># location ~* .(jpg|jpeg|gif|png|webp|svg|woff|woff2|ttf|css|js|ico|xml)$ &#123;</span><br><span class="line"># access_log off;</span><br><span class="line"># log_not_found off;</span><br><span class="line"># expires 360d;</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Step4-Configure-Postfix"><a href="#Step4-Configure-Postfix" class="headerlink" title="Step4. Configure Postfix"></a>Step4. Configure Postfix</h1><p>Install and start Postfix.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># dnf -y install postfix postfix-mysql</span><br><span class="line"># systemctl enable --now postfix</span><br></pre></td></tr></table></figure><p>Edit Postfix main config file with following command. This will defined our <code>domain</code> <code>hostname</code> <code>tls_level</code> etc…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cp /etc/postfix/main.cf /etc/postfix/main.cf.bak</span><br><span class="line"># vim /etc/postfix/main.cf</span><br></pre></td></tr></table></figure><p><a href="/resources/0e222d97baca4600b523da77666a1419.cf">main.cf</a></p><p>We can configure postfix by direct modifying above file or use following <code>postconf</code> command.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Change to:</span><br><span class="line"># postconf -e &quot;inet_interfaces = all&quot;</span><br><span class="line"># postconf -e &#x27;inet_protocols = ipv4&#x27;</span><br><span class="line"># postconf &#x27;smtpd_tls_cert_file = /etc/pki/tls/certs/mail.example.com.crt&#x27;</span><br><span class="line"># postconf &#x27;smtpd_tls_key_file = /etc/pki/tls/private/mail.example.com.key&#x27;</span><br><span class="line">Add:</span><br><span class="line"># postconf -e &#x27;smtp_address_preference = ipv4&#x27;</span><br><span class="line"># postconf &quot;smtpd_tls_loglevel = 1&quot;</span><br><span class="line"># postconf &quot;smtp_tls_loglevel = 1&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#Add following to the end of the file.</span><br><span class="line"># Force TLSv1.3 or TLSv1.2</span><br><span class="line">smtpd_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1</span><br><span class="line">smtpd_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1</span><br><span class="line">smtp_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1</span><br><span class="line">smtp_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1</span><br><span class="line"></span><br><span class="line">mailbox_transport = lmtp:unix:private/dovecot-lmtp</span><br><span class="line">smtputf8_enable = no</span><br><span class="line"></span><br><span class="line">virtual_mailbox_domains = proxy:mysql:/etc/postfix/sql/mysql_virtual_domains_maps.cf</span><br><span class="line">virtual_mailbox_maps =</span><br><span class="line">proxy:mysql:/etc/postfix/sql/mysql_virtual_mailbox_maps.cf,</span><br><span class="line">proxy:mysql:/etc/postfix/sql/mysql_virtual_alias_domain_mailbox_maps.cf</span><br><span class="line">virtual_alias_maps =</span><br><span class="line">proxy:mysql:/etc/postfix/sql/mysql_virtual_alias_maps.cf,</span><br><span class="line">proxy:mysql:/etc/postfix/sql/mysql_virtual_alias_domain_maps.cf,</span><br><span class="line">proxy:mysql:/etc/postfix/sql/mysql_virtual_alias_domain_catchall_maps.cf</span><br><span class="line">virtual_transport = lmtp:unix:private/dovecot-lmtp</span><br><span class="line"></span><br><span class="line">virtual_mailbox_base = /var/vmail</span><br><span class="line">virtual_minimum_uid = 2000</span><br><span class="line">virtual_uid_maps = static:2000</span><br><span class="line">virtual_gid_maps = static:2000</span><br></pre></td></tr></table></figure><p>Enable Submssion port (587) and SMTP-S (465) by editting <code>/etc/postfix/master.cf</code> file.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cp /etc/postfix/master.cf /etc/postfix/master.cf.bak</span><br><span class="line"># vim /etc/postfix/master.cf</span><br></pre></td></tr></table></figure><p><a href="/resources/aef18d6512de4fffa179363b41ca9710.cf">master.cf</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># For Submission</span><br><span class="line">submission inet n - y - - smtpd</span><br><span class="line">-o syslog_name=postfix/submission</span><br><span class="line">-o smtpd_tls_security_level=encrypt</span><br><span class="line">-o smtpd_tls_wrappermode=no</span><br><span class="line">-o smtpd_sasl_auth_enable=yes</span><br><span class="line">-o smtpd_relay_restrictions=permit_sasl_authenticated,reject</span><br><span class="line">-o smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject</span><br><span class="line">-o smtpd_sasl_type=dovecot</span><br><span class="line">-o smtpd_sasl_path=private/auth</span><br><span class="line"></span><br><span class="line"># For SMTP-S</span><br><span class="line">smtps inet n - y - - smtpd</span><br><span class="line">-o syslog_name=postfix/smtps</span><br><span class="line">-o smtpd_tls_wrappermode=yes</span><br><span class="line">-o smtpd_sasl_auth_enable=yes</span><br><span class="line">-o smtpd_relay_restrictions=permit_sasl_authenticated,reject</span><br><span class="line">-o smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject</span><br><span class="line">-o smtpd_sasl_type=dovecot</span><br><span class="line">-o smtpd_sasl_path=private/auth</span><br></pre></td></tr></table></figure><p>(Option) We can follow the steps below to create a watchdog to prevent the service from terminating unexpectedly.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p /etc/systemd/system/postfix.service.d/</span><br><span class="line"># vim /etc/systemd/system/postfix.service.d/restart.conf</span><br><span class="line">[Service]</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5s</span><br></pre></td></tr></table></figure><p>(Option) Verify the watchdog is working.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># systemctl daemon-reload</span><br><span class="line"># pkill master</span><br><span class="line"># systemctl status postfix</span><br></pre></td></tr></table></figure><h1 id="Step5-Configure-Dovecot"><a href="#Step5-Configure-Dovecot" class="headerlink" title="Step5. Configure Dovecot"></a>Step5. Configure Dovecot</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># dnf -y install dovecot dovecot-mysql</span><br><span class="line"># systemctl enable --now dovecot</span><br></pre></td></tr></table></figure><p>Add the dovecot to the mail group.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># gpasswd -a dovecot mail</span><br></pre></td></tr></table></figure><p>Add the web server(nginx) to the dovecot group.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># gpasswd -a nginx dovecot</span><br></pre></td></tr></table></figure><p>Generating DH parameters, This is going to take a long time.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># openssl dhparam -out /etc/dovecot/dh.pem 4096</span><br></pre></td></tr></table></figure><p>Uncomment following line and remove <del>submission</del> because we have enabled submission using Postfix.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cp /etc/dovecot/dovecot.conf /etc/dovecot/dovecot.conf.bak</span><br><span class="line"># vim /etc/dovecot/dovecot.conf</span><br><span class="line">#protocols = imap pop3 lmtp submission</span><br><span class="line">protocols = imap pop3 lmtp</span><br></pre></td></tr></table></figure><p>Create new file and fill in the following. This will enable Dovecot to connect to our MySQL database.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/dovecot/dovecot-sql.conf.ext</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">driver = mysql</span><br><span class="line">connect = host=localhost dbname=postfixadmin user=postfixadmin password=YourPassword</span><br><span class="line">default_pass_scheme = SHA512</span><br><span class="line">password_query = SELECT username AS user,password FROM mailbox WHERE username = &#x27;%u&#x27; AND active=&#x27;1&#x27;</span><br><span class="line">user_query = SELECT maildir, 2000 AS uid, 2000 AS gid FROM mailbox WHERE username = &#x27;%u&#x27; AND active=&#x27;1&#x27;</span><br><span class="line">iterate_query = SELECT username AS user FROM mailbox</span><br></pre></td></tr></table></figure><p>Modify the file as below. This will define the mail location as well as the namespace.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/dovecot/conf.d/10-mail.conf</span><br><span class="line"># Add following in the end.</span><br><span class="line">mail_location = maildir:~/Maildir</span><br><span class="line">mail_home = /var/vmail/%d/%n</span><br><span class="line">mail_privileged_group = mail</span><br></pre></td></tr></table></figure><p>Add the following lines to the end of this file.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cp /etc/dovecot/conf.d/10-master.conf /etc/dovecot/conf.d/10-master.conf.bak</span><br><span class="line"># vim /etc/dovecot/conf.d/10-master.conf</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#Add following in the end of the file.</span><br><span class="line">service stats &#123;</span><br><span class="line">unix_listener stats-reader &#123;</span><br><span class="line">user = nginx</span><br><span class="line">group = nginx</span><br><span class="line">mode = 0660</span><br><span class="line">&#125;</span><br><span class="line">unix_listener stats-writer &#123;</span><br><span class="line">user = nginx</span><br><span class="line">group = nginx</span><br><span class="line">mode = 0660</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Configuring Authentication Mechanism.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># cp /etc/dovecot/conf.d/10-auth.conf /etc/dovecot/conf.d/10-auth.conf.bak</span><br><span class="line"># vim /etc/dovecot/conf.d/10-auth.conf</span><br><span class="line">#Change to:</span><br><span class="line">auth_username_format = %u</span><br><span class="line">auth_mechanisms = plain login</span><br><span class="line">!include auth-sql.conf.ext</span><br><span class="line">auth_debug = yes</span><br><span class="line">auth_debug_passwords = yes</span><br></pre></td></tr></table></figure><p>Configuring SSL&#x2F;TLS Encryption.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># cp /etc/dovecot/conf.d/10-ssl.conf /etc/dovecot/conf.d/10-ssl.conf.bak</span><br><span class="line"># vim /etc/dovecot/conf.d/10-ssl.conf</span><br><span class="line">#Change to:</span><br><span class="line">ssl = required</span><br><span class="line">ssl_cert = &lt;/etc/pki/tls/certs/mail.example.com.crt</span><br><span class="line">ssl_key = &lt;/etc/pki/tls/private/mail.example.com.key</span><br><span class="line">ssl_dh = &lt;/etc/dovecot/dh.pem</span><br><span class="line">ssl_min_protocol = TLSv1.2</span><br><span class="line">ssl_cipher_list = PROFILE=SYSTEM</span><br><span class="line">ssl_prefer_server_ciphers = yes</span><br></pre></td></tr></table></figure><p>SASL Authentication Between Postfix and Dovecot.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/dovecot/conf.d/10-master.conf</span><br><span class="line"># Change to:</span><br><span class="line">service lmtp &#123;</span><br><span class="line">unix_listener /var/spool/postfix/private/dovecot-lmtp &#123;</span><br><span class="line">mode = 0600</span><br><span class="line">user = postfix</span><br><span class="line">group = postfix</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">service auth &#123;</span><br><span class="line">unix_listener /var/spool/postfix/private/auth &#123;</span><br><span class="line">mode = 0600</span><br><span class="line">user = postfix</span><br><span class="line">group = postfix</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Edit the following file like below. This will auto-create <code>Sent</code> ,<code>Junk</code>, <code>Drafts</code>and <code>Trash</code> Folder.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># cp /etc/dovecot/conf.d/15-mailboxes.conf /etc/dovecot/conf.d/15-mailboxes.conf.bak</span><br><span class="line"># vim /etc/dovecot/conf.d/15-mailboxes.conf</span><br><span class="line">namespace inbox &#123;</span><br><span class="line"># These mailboxes are widely used and could perhaps be created automatically:</span><br><span class="line">mailbox Drafts &#123;</span><br><span class="line">auto = create</span><br><span class="line">special_use = Drafts</span><br><span class="line">&#125;</span><br><span class="line">mailbox Junk &#123;</span><br><span class="line">auto = create</span><br><span class="line">special_use = Junk</span><br><span class="line">&#125;</span><br><span class="line">mailbox Trash &#123;</span><br><span class="line">auto = create</span><br><span class="line">special_use = Trash</span><br><span class="line">&#125;</span><br><span class="line">mailbox Sent &#123;</span><br><span class="line">auto = create</span><br><span class="line">special_use = Sent</span><br><span class="line">&#125;</span><br><span class="line">mailbox &quot;Sent Messages&quot; &#123;</span><br><span class="line">special_use = Sent</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now we need to restart the Postfix and dovecot services.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># systemctl restart postfix dovecot</span><br><span class="line"># systemctl status postfix</span><br><span class="line"># systemctl status dovecot</span><br></pre></td></tr></table></figure><h1 id="Step6-Configure-Postfixadmin"><a href="#Step6-Configure-Postfixadmin" class="headerlink" title="Step6. Configure Postfixadmin"></a>Step6. Configure Postfixadmin</h1><p>Check <a href="https://github.com/postfixadmin/postfixadmin/releases">https://github.com/postfixadmin/postfixadmin/releases</a> to get the latest stable release first. And then we need to download the tarball via <code>wget</code> command.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># wget https://github.com/postfixadmin/postfixadmin/archive/postfixadmin-3.3.11.tar.gz</span><br><span class="line"># tar -zxvf postfixadmin-3.3.11.tar.gz</span><br><span class="line"># mv postfixadmin-postfixadmin-3.3.11/ /usr/share/nginx/postfixadmin</span><br><span class="line"># mkdir -p /usr/share/nginx/postfixadmin/templates_c</span><br></pre></td></tr></table></figure><p>Create the following new file and fill it like below. This will enable PostfixAdmin connect MySQL database and update password by PHP.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># vim /usr/share/nginx/postfixadmin/config.local.php</span><br><span class="line">&lt;?php</span><br><span class="line">$CONF[&#x27;configured&#x27;] = true;</span><br><span class="line">$CONF[&#x27;database_type&#x27;] = &#x27;mysqli&#x27;;</span><br><span class="line">$CONF[&#x27;database_host&#x27;] = &#x27;localhost&#x27;;</span><br><span class="line">$CONF[&#x27;database_port&#x27;] = &#x27;3306&#x27;;</span><br><span class="line">$CONF[&#x27;database_user&#x27;] = &#x27;postfixadmin&#x27;;</span><br><span class="line">$CONF[&#x27;database_password&#x27;] = &#x27;YourPassword&#x27;;</span><br><span class="line">$CONF[&#x27;database_name&#x27;] = &#x27;postfixadmin&#x27;;</span><br><span class="line">$CONF[&#x27;encrypt&#x27;] = &#x27;dovecot:SHA512&#x27;;</span><br><span class="line">$CONF[&#x27;dovecotpw&#x27;] = &quot;/usr/bin/doveadm pw -r 12&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chown -R nginx:nginx /usr/share/nginx/postfixadmin/</span><br></pre></td></tr></table></figure><p>Make following directory.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p /etc/postfix/sql/</span><br></pre></td></tr></table></figure><p>Create following files and make sure they are set with permissions to be accessible by Postfix user.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/postfix/sql/mysql_virtual_domains_maps.cf</span><br><span class="line">user = postfixadmin</span><br><span class="line">password = YourPassword</span><br><span class="line">hosts = localhost</span><br><span class="line">dbname = postfixadmin</span><br><span class="line">query = SELECT domain FROM domain WHERE domain=&#x27;%s&#x27; AND active = &#x27;1&#x27;</span><br><span class="line">#query = SELECT domain FROM domain WHERE domain=&#x27;%s&#x27;</span><br><span class="line">#optional query to use when relaying for backup MX</span><br><span class="line">#query = SELECT domain FROM domain WHERE domain=&#x27;%s&#x27; AND backupmx = &#x27;0&#x27; AND active = &#x27;1&#x27;</span><br><span class="line">#expansion_limit = 100</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/postfix/sql/mysql_virtual_mailbox_maps.cf</span><br><span class="line">user = postfixadmin</span><br><span class="line">password = YourPassword</span><br><span class="line">hosts = localhost</span><br><span class="line">dbname = postfixadmin</span><br><span class="line">query = SELECT maildir FROM mailbox WHERE username=&#x27;%s&#x27; AND active = &#x27;1&#x27;</span><br><span class="line">#expansion_limit = 100</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/postfix/sql/mysql_virtual_alias_domain_mailbox_maps.cf</span><br><span class="line">user = postfixadmin</span><br><span class="line">password = YourPassword</span><br><span class="line">hosts = localhost</span><br><span class="line">dbname = postfixadmin</span><br><span class="line">query = SELECT maildir FROM mailbox,alias_domain WHERE alias_domain.alias_domain = &#x27;%d&#x27; and mailbox.username = CONCAT(&#x27;%u&#x27;, &#x27;@&#x27;, alias_domain.target_domain) AND mailbox.active = 1 AND alias_domain.active=&#x27;1&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/postfix/sql/mysql_virtual_alias_maps.cf</span><br><span class="line">user = postfixadmin</span><br><span class="line">password = YourPassword</span><br><span class="line">hosts = localhost</span><br><span class="line">dbname = postfixadmin</span><br><span class="line">query = SELECT goto FROM alias WHERE address=&#x27;%s&#x27; AND active = &#x27;1&#x27;</span><br><span class="line">#expansion_limit = 100</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/postfix/sql/mysql_virtual_alias_domain_maps.cf</span><br><span class="line">user = postfixadmin</span><br><span class="line">password = YourPassword</span><br><span class="line">hosts = localhost</span><br><span class="line">dbname = postfixadmin</span><br><span class="line">query = SELECT goto FROM alias,alias_domain WHERE alias_domain.alias_domain = &#x27;%d&#x27; and alias.address = CONCAT(&#x27;%u&#x27;, &#x27;@&#x27;, alias_domain.target_domain) AND alias.active = 1 AND alias_domain.active=&#x27;1&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/postfix/sql/mysql_virtual_alias_domain_catchall_maps.cf</span><br><span class="line">user = postfixadmin</span><br><span class="line">password = YourPassword</span><br><span class="line">hosts = localhost</span><br><span class="line">dbname = postfixadmin</span><br><span class="line">query = SELECT goto FROM alias,alias_domain WHERE alias_domain.alias_domain = &#x27;%d&#x27; and alias.address = CONCAT(&#x27;@&#x27;, alias_domain.target_domain) AND alias.active = 1 AND alias_domain.active=&#x27;1&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod 0640 /etc/postfix/sql/*</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># adduser vmail --system --uid 2000 --user-group --no-create-home</span><br><span class="line"># mkdir /var/vmail/</span><br><span class="line"># chown vmail:vmail /var/vmail/ -R</span><br><span class="line"># chown -R postfix:postfix /etc/postfix/sql/</span><br><span class="line"># chown -R nginx:nginx /var/lib/php/opcache/</span><br><span class="line"># chown -R nginx:nginx /var/lib/php/session/</span><br><span class="line"># chown -R nginx:nginx /var/lib/php/wsdlcache/</span><br><span class="line"># chown nginx:nginx /etc/pki/tls/certs/mail.example.com.crt</span><br><span class="line"># chown nginx:nginx /etc/pki/tls/private/mail.example.com.key</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># nginx -t</span><br><span class="line"># nginx -s reload</span><br></pre></td></tr></table></figure><p>Open our browser and enter following URL to complete PostfixAdmin setup.<br><a href="https://mail.example.com/postfixadmin/setup.php">https://mail.example.com/postfixadmin/setup.php</a><br><img src="/resources/56ef873134dc4730af5e4c076f0a142d.png" alt="d470a41ee4e4f239da08aa8cce8454e6.png"><br>You can generate a password hash through <code>php -r &#39;echo password_hash(&quot;YourPassword&quot;, PASSWORD_DEFAULT);&#39;</code> command.<br>Now you need to add following line to the <code>/usr/share/nginx/postfixadmin/config.local.php</code> file in the end.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$CONF[&#x27;setup_password&#x27;] = &#x27;Your_Password&#x27;s_Hash&#x27;;</span><br></pre></td></tr></table></figure><p>Follow the setup wizard to create an Administrator user and login.<br><img src="/resources/968a63824b734664bdf63ddc612b5149.png" alt="3033bf031c1ee6c2d69ada9fd9efacb9.png"><br>Now you can create Domain and Mailboxes in PostfixAdmin.</p><blockquote><p>Reference:<br><a href="https://github.com/postfixadmin/postfixadmin/tree/master/DOCUMENTS">https://github.com/postfixadmin/postfixadmin/tree/master/DOCUMENTS</a><br><a href="https://raw.githubusercontent.com/postfixadmin/postfixadmin/master/INSTALL.TXT">https://raw.githubusercontent.com/postfixadmin/postfixadmin/master/INSTALL.TXT</a></p></blockquote><h1 id="Step7-Configure-RoundCube"><a href="#Step7-Configure-RoundCube" class="headerlink" title="Step7. Configure RoundCube"></a>Step7. Configure RoundCube</h1><p>RoundCube is a WebGUI IMAP client.<br>Download Roundcube Webmail from <a href="https://github.com/roundcube/roundcubemail/releases">https://github.com/roundcube/roundcubemail/releases</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># wget https://github.com/roundcube/roundcubemail/releases/download/1.5.2/roundcubemail-1.5.2-complete.tar.gz</span><br><span class="line"># tar -zxvf roundcubemail-1.5.2-complete.tar.gz</span><br><span class="line"># mv roundcubemail-1.5.2 /usr/share/nginx/roundcube</span><br><span class="line"># chown nginx:nginx -R /usr/share/nginx/roundcube/</span><br><span class="line"># dnf install php-ldap php-imagick php-common php-gd php-imap php-json php-curl php-zip php-xml php-mbstring php-bz2 php-intl php-gmp -y</span><br></pre></td></tr></table></figure><p>Add your Private CA’s certificate in the end of the following file.</p><blockquote><p>Note: This needs to be saved forcibly with <code>:wq!</code>.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line">#Add the following to the end of the file.</span><br><span class="line"># My Private CA Certificate.</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">...</span><br><span class="line">Your CA certificate.</span><br><span class="line">...</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure><p>Now you need to open your browser and enter following URL to continue RoundCube setup.<br><a href="https://email.example.com/installer">https://email.example.com/installer</a><br><img src="/resources/da9e0417bc4148dc84619435b459a634.png" alt="3de277f1cb80d92e700afa2291ec518e.png"></p><p>Fill Database setup.<br><img src="/resources/1280d8cac4354e059b2d5bdb569f553c.png" alt="4cc2d3c216084c4f53fe8d31790cc077.png"><br>Fill IMAP setup.<br>IMAP server: <code>ssl://email.example.com</code> port: 993<br><img src="/resources/15047935b37a48d8b80e2e96113edfdd.png" alt="17011cf931373d801743e7e838af5caa.png"><br>SMTP server: <code>tls://email.example.com</code> port: 587<br>SMTP server: <code>ssl://email.example.com</code> port: 465<br><img src="/resources/ef129191e5c6400bb41f2b264df87b1f.png" alt="9cf36687ab8c8aa16a10237452a68fc4.png"><br>Next, you can scroll down to the Plugins section to enable some plugins. For example: the password plugin, mark as junk plugin and so on. I enabled all of them.<br><img src="/resources/4cf2d9a8596b47dea678335543e9b345.png" alt="25aa9951a611254091e5c49fe38f0546.png"><br><img src="/resources/202413271cbf457ba0f75f5874a0bc9d.png" alt="1c5dfe3f1776c20a82dc3767da2f8615.png"><br><img src="/resources/f847d7cf9b224785b8482e7559a472e8.png" alt="9dc291c4498b0bd990eb5576c49d6af0.png"><br>Make sure the password plugin in the plugin list at the end of this file. The plugin order doesn’t matter.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># grep &#x27;password&#x27; /usr/share/nginx/roundcube/config/config.inc.php</span><br></pre></td></tr></table></figure><p>Create the new PHP file by copying the file below and modify it like following. This will enable RoundCube to connect our MySQL database and update password.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cp /usr/share/nginx/roundcube/plugins/password/config.inc.php.dist /usr/share/nginx/roundcube/plugins/password/config.inc.php</span><br><span class="line">vim /usr/share/nginx/roundcube/plugins/password/config.inc.php</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#Change the value to:</span><br><span class="line">$config[&#x27;password_db_dsn&#x27;] = &#x27;mysql://postfixadmin:YourPassword@127.0.0.1/postfixadmin&#x27;;</span><br><span class="line">$config[&#x27;password_query&#x27;] = &#x27;UPDATE mailbox SET password=%D,modified=NOW() WHERE username=%u&#x27;;</span><br><span class="line">$config[&#x27;password_strength_driver&#x27;] = &#x27;zxcvbn&#x27;;</span><br><span class="line">$config[&#x27;password_zxcvbn_min_score&#x27;] = 5;</span><br><span class="line">$config[&#x27;password_algorithm&#x27;] = &#x27;dovecot&#x27;;</span><br><span class="line">$config[&#x27;password_dovecotpw&#x27;] = &#x27;/usr/bin/doveadm pw -r 12&#x27;;</span><br><span class="line">$config[&#x27;password_dovecotpw_method&#x27;] = &#x27;SHA512&#x27;;</span><br><span class="line">$config[&#x27;password_dovecotpw_with_method&#x27;] = true;</span><br></pre></td></tr></table></figure><p><a href="/resources/dea4c2783658451c979438a687261219.php">config.inc.php</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># chown nginx:nginx /usr/share/nginx/roundcube/plugins/password/config.inc.php</span><br><span class="line"># chmod 600 /usr/share/nginx/roundcube/plugins/password/config.inc.php</span><br><span class="line"># echo &quot;$config[&#x27;enable_installer&#x27;] = true;&quot; &gt;&gt; /usr/share/nginx/roundcube/config/config.inc.php</span><br></pre></td></tr></table></figure><p>Close the browser and enter following URL to complete set up.<br><a href="https://email.example.com/installer/index.php?_step=3">https://email.example.com/installer/index.php?_step=3</a><br>Send test<br><img src="/resources/b9bf213308ec4609b63b6b12e9ceb9c3.png" alt="c9e11f23949605bfd8b04455e627ffeb.png"><br><img src="/resources/91a0bc77b06f4a1daee68fb7a6826d79.png" alt="aa845e73437a5ee48f3dda613c050b77.png"><br>Login test<br><img src="/resources/2f69fc9c3e3045a28a29277368d8412a.png" alt="5be748fdc44ae54c05b97fc308998f63.png"><br>After completing the installation and the final tests please remove the whole installer folder from the document root of the webserver or make sure that enable_installer option in config.inc.php is disabled.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># rm -rf /usr/share/nginx/roundcube/installer/</span><br><span class="line">vim /usr/share/nginx/roundcube/config/config.inc.php</span><br><span class="line">Change to:</span><br><span class="line">$config[&#x27;enable_installer&#x27;]=false;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># nginx -t</span><br><span class="line"># nginx -s reload</span><br></pre></td></tr></table></figure><p>Close the browser and enter following URL to login your account.<br><a href="https://mail.example.com/postfixadmin/setup.php">https://mail.example.com/postfixadmin/setup.php</a><br><a href="https://mail.example.com/">https://mail.example.com</a></p><blockquote><p>Reference:<br><a href="https://www.linuxbabe.com/redhat/postfixadmin-create-virtual-mailboxes-centos-mail-server">https://www.linuxbabe.com/redhat/postfixadmin-create-virtual-mailboxes-centos-mail-server</a><br><a href="https://www.linuxbabe.com/redhat/install-roundcube-webmail-centos-8-rhel-8-apache-nginx#out-of-office">https://www.linuxbabe.com/redhat/install-roundcube-webmail-centos-8-rhel-8-apache-nginx#out-of-office</a></p></blockquote><h1 id="TroubleShooting"><a href="#TroubleShooting" class="headerlink" title="TroubleShooting"></a>TroubleShooting</h1><p>Perform a user lookup in Dovecot’s userdbs.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># doveadm user &#x27;*&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># journalctl -eu dovecot</span><br><span class="line"># vim /var/log/maillog</span><br><span class="line"># mail user@gmail.com</span><br><span class="line"># vim /etc/aliases</span><br><span class="line"># newaliases</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Objective&quot;&gt;&lt;a href=&quot;#Objective&quot; class=&quot;headerlink&quot; title=&quot;Objective&quot;&gt;&lt;/a&gt;Objective&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;Local network (web)mail server.&lt;/li&gt;</summary>
      
    
    
    
    <category term="Linux" scheme="https://kenryu.cc/categories/Linux/"/>
    
    
    <category term="Server" scheme="https://kenryu.cc/tags/Server/"/>
    
    <category term="Nginx" scheme="https://kenryu.cc/tags/Nginx/"/>
    
    <category term="MySQL" scheme="https://kenryu.cc/tags/MySQL/"/>
    
    <category term="PHP" scheme="https://kenryu.cc/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>phpipam</title>
    <link href="https://kenryu.cc/2022/04/19/Linux/phpipam/"/>
    <id>https://kenryu.cc/2022/04/19/Linux/phpipam/</id>
    <published>2022-04-19T08:58:10.000Z</published>
    <updated>2022-08-03T01:54:13.545Z</updated>
    
    <content type="html"><![CDATA[<p>LNMP<br>[toc]</p><table><thead><tr><th>Name</th><th>Version</th><th>Command</th></tr></thead><tbody><tr><td>phpIPAM</td><td>1.5</td><td>cd &#x2F;var&#x2F;www&#x2F;phpipam&#x2F; &amp;&amp; git log</td></tr><tr><td>Linux</td><td>Rocky Linux release 8.5 (Green Obsidian)</td><td>cat &#x2F;etc&#x2F;lsb-release &#x2F;etc&#x2F;os-release</td></tr><tr><td>Nginx</td><td>nginx version: nginx&#x2F;1.20.2</td><td>nginx -v</td></tr><tr><td>MySQL</td><td>mysql Ver 8.0.28 for Linux on x86_64 (MySQL Community Server - GPL)</td><td>mysql –version</td></tr><tr><td>PHP</td><td>PHP 7.3.20 (cli) (built: Jul 7 2020 07:53:49) ( NTS )</td><td>php -v</td></tr></tbody></table><h2 id="phpipam"><a href="#phpipam" class="headerlink" title="phpipam"></a>phpipam</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dnf -y install php-gmp git</span><br><span class="line">git clone https://github.com/phpipam/phpipam.git /var/www/phpipam</span><br><span class="line">chown -R nginx:nginx /var/www/phpipam</span><br><span class="line">cp /var/www/phpipam/config.dist.php /var/www/phpipam/config.php</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /var/www/phpipam/config.php</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$db[&#x27;host&#x27;] = &#x27;127.0.0.1&#x27;;</span><br><span class="line">$db[&#x27;user&#x27;] = &#x27;phpipam&#x27;;</span><br><span class="line">$db[&#x27;pass&#x27;] = &#x27;Your_Password&#x27;;</span><br><span class="line">$db[&#x27;name&#x27;] = &#x27;phpipam&#x27;;</span><br><span class="line">$db[&#x27;port&#x27;] = 3306;</span><br></pre></td></tr></table></figure><h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># mysql -u root -p</span><br><span class="line">mysql&gt; create database phpipam;</span><br><span class="line">mysql&gt; create user phpipam@localhost identified with mysql_native_password by &#x27;P@ssw0rd&#x27;;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON phpipam.* TO phpipam@localhost;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/php-fpm.d/www.conf</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- user = apache</span><br><span class="line">- group = apache</span><br><span class="line">+ user = nginx</span><br><span class="line">+ group = nginx</span><br><span class="line">+ listen.owner = nginx</span><br><span class="line">+ listen.group = nginx</span><br><span class="line">+ listen.mode = 0660</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;&lt;?php phpinfo(); ?&gt;&quot; &gt;&gt; /usr/share/nginx/html/index.php</span><br><span class="line">systemctl restart php-fpm.service</span><br></pre></td></tr></table></figure><h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>Backup nginx default config file.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.bak</span><br></pre></td></tr></table></figure><p>Edit site config file .</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/conf.d/ipam.kensho.toda.conf</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 443 ssl http2;</span><br><span class="line">server_name ipam.kensho.toda;</span><br><span class="line">root /var/www/phpipam;</span><br><span class="line">index index.php;</span><br><span class="line"></span><br><span class="line">ssl_certificate &quot;/etc/pki/nginx/ipam.kensho.toda.crt&quot;;</span><br><span class="line">ssl_certificate_key &quot;/etc/pki/nginx/private/ipam.kensho.toda.key&quot;;</span><br><span class="line">ssl_session_cache shared:SSL:1m;</span><br><span class="line">ssl_session_timeout 10m;</span><br><span class="line">ssl_ciphers PROFILE=SYSTEM;</span><br><span class="line">ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">try_files $uri $uri/ /phpipam/index.php;</span><br><span class="line">index index.php;</span><br><span class="line">&#125;</span><br><span class="line">location /api/ &#123;</span><br><span class="line">try_files $uri $uri/ /phpipam/api/index.php;</span><br><span class="line">&#125;</span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">fastcgi_pass unix:/run/php-fpm/www.sock;</span><br><span class="line">fastcgi_index index.php;</span><br><span class="line">try_files $uri $uri/ index.php = 404;</span><br><span class="line">fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">include fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name ipam.kensho.toda;</span><br><span class="line">return 301 https://ipam.kensho.toda$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><h2 id="Complete-the-initial-configuration-wizard"><a href="#Complete-the-initial-configuration-wizard" class="headerlink" title="Complete the initial configuration wizard"></a>Complete the initial configuration wizard</h2><p><img src="/resources/e20d331a346c4df1a9d79f0280535d60.png" alt="c82bd586d5a8c037e3ae38c9c9e04aaa.png"></p><p><img src="/resources/2efc6bc066444483937a6857aa8290bc.png" alt="73a9d5e21d38e3d58c7cd9d6778e4a67.png"></p><p>The default Login credentials are:</p><ul><li>Username: admin</li><li>Password: ipamadmin</li></ul><h2 id="Toubleshoting"><a href="#Toubleshoting" class="headerlink" title="Toubleshoting"></a>Toubleshoting</h2><p>Reset phpipam admin password.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php /var/www/phpipam/functions/scripts/reset-admin-password.php</span><br></pre></td></tr></table></figure><p>Check database’s user.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mysql -u root -p</span><br><span class="line">mysql&gt; use mysql;</span><br><span class="line">mysql&gt; select user,host,plugin from user;</span><br></pre></td></tr></table></figure><h2 id="Schedule-check-ip-via-cron"><a href="#Schedule-check-ip-via-cron" class="headerlink" title="Schedule check-ip via cron"></a>Schedule check-ip via cron</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># crontab -e</span><br><span class="line">*/15 Install_JavaScripts_via_npm.sh README.md _config.landscape.yml _config.yml db.json i18n joplin2hexo node_modules package.json public scaffolds source themes tmp Install_JavaScripts_via_npm.sh README.md _config.landscape.yml _config.yml db.json i18n joplin2hexo node_modules package.json public scaffolds source themes tmp Install_JavaScripts_via_npm.sh README.md _config.landscape.yml _config.yml db.json i18n joplin2hexo node_modules package.json public scaffolds source themes tmp Install_JavaScripts_via_npm.sh README.md _config.landscape.yml _config.yml db.json i18n joplin2hexo node_modules package.json public scaffolds source themes tmp root /usr/bin/php /var/www/phpipam/functions/scripts/pingCheck.php</span><br><span class="line">*/15 Install_JavaScripts_via_npm.sh README.md _config.landscape.yml _config.yml db.json i18n joplin2hexo node_modules package.json public scaffolds source themes tmp Install_JavaScripts_via_npm.sh README.md _config.landscape.yml _config.yml db.json i18n joplin2hexo node_modules package.json public scaffolds source themes tmp Install_JavaScripts_via_npm.sh README.md _config.landscape.yml _config.yml db.json i18n joplin2hexo node_modules package.json public scaffolds source themes tmp Install_JavaScripts_via_npm.sh README.md _config.landscape.yml _config.yml db.json i18n joplin2hexo node_modules package.json public scaffolds source themes tmp root /usr/bin/php /var/www/phpipam/functions/scripts/discoveryCheck.php</span><br><span class="line"># crontab -l</span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ol><li><a href="https://github.com/phpipam/phpipam">https://github.com/phpipam/phpipam</a></li><li><a href="https://phpipam.net/documents/installation/">https://phpipam.net/documents/installation/</a></li><li><a href="https://phpipam.net/news/phpipam-on-nginx/">https://phpipam.net/news/phpipam-on-nginx/</a></li><li><a href="https://computingforgeeks.com/install-and-configure-phpipam-on-ubuntu-debian-linux/">https://computingforgeeks.com/install-and-configure-phpipam-on-ubuntu-debian-linux/</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;LNMP&lt;br&gt;[toc]&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Name&lt;/th&gt;
&lt;th&gt;Version&lt;/th&gt;
&lt;th&gt;Command&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;phpIPAM&lt;/td&gt;
&lt;td&gt;1.</summary>
      
    
    
    
    <category term="Linux" scheme="https://kenryu.cc/categories/Linux/"/>
    
    
  </entry>
  
  <entry>
    <title>ZFS常用命令</title>
    <link href="https://kenryu.cc/2022/02/28/ZFS/ZFS%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <id>https://kenryu.cc/2022/02/28/ZFS/ZFS%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</id>
    <published>2022-02-28T06:52:32.000Z</published>
    <updated>2022-06-30T00:45:55.820Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-创建pool和ZFS文件系统"><a href="#1-创建pool和ZFS文件系统" class="headerlink" title="1. 创建pool和ZFS文件系统"></a>1. 创建pool和ZFS文件系统</h1><ul><li><p>创建名为 “tank” 的存储池 (type: ,mirror,raidz,raidz2,raidz3)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zpool create tank &lt;type&gt; sdb sdc sdd sde</span><br></pre></td></tr></table></figure><blockquote><p>注意： Linux的大多数情况下，sda，sdb，sdc并没有按照slot的顺序排列，是乱序的。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find -L /dev/disk/by-id -samefile /dev/sda</span><br></pre></td></tr></table></figure></li><li><p>向池中添加更多空间</p><blockquote><p>池(pool)中的其他空间(vdev)要相同type，相同数量。否则出现”mismatched replication level”错误。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zpool add tank mirror sdf sdg</span><br></pre></td></tr></table></figure></li><li><p>创建文件系统，挂载在 &#x2F;export&#x2F;home 下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># zfs create tank/home</span><br><span class="line"># df -Th</span><br><span class="line"># zfs set mountpoint=/export/home tank/home</span><br></pre></td></tr></table></figure></li><li><p>为多个用户创建起始目录<br>t&gt; 请注意：由于继承而自动挂载在 &#x2F;export&#x2F;home&#x2F;{ahrens,bonwick,billm} 下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># zfs create tank/home/ahrens</span><br><span class="line"># zfs create tank/home/bonwick</span><br><span class="line"># zfs create tank/home/billm</span><br></pre></td></tr></table></figure></li><li><p>修改文件系统名称</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs rename tank/home/ahrens tank/home/nahrens</span><br></pre></td></tr></table></figure></li><li><p>删除文件系统</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs destroy -Rf tank/fs</span><br></pre></td></tr></table></figure></li><li><p>修改存储池的名称</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># zpool export tank</span><br><span class="line"></span><br><span class="line"># zpool import tank newpool</span><br></pre></td></tr></table></figure></li></ul><h1 id="2-设置属性"><a href="#2-设置属性" class="headerlink" title="2. 设置属性"></a>2. 设置属性</h1><ul><li>自动以 NFS 方式共享该文件系统<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs set sharenfs=rw tank/home</span><br></pre></td></tr></table></figure></li><li>对文件系统中所有数据启用压缩<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs set compression=on tank</span><br></pre></td></tr></table></figure></li><li>将用户 A的最大空间限制为 10g<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs set quota=10g tank/home/userA</span><br></pre></td></tr></table></figure></li><li>保证用户 B有 20g 的预留空间<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs set reservation=20g tank/home/userB</span><br></pre></td></tr></table></figure></li><li>可通过命令查询文件系统的所有属性<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs get all tank/home</span><br></pre></td></tr></table></figure></li><li>可通过命令查询存储池的所有属性<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zpool get all tank</span><br></pre></td></tr></table></figure></li><li>大多数属性可通过继承方式自动设置 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs inherit &lt;property&gt; tank/home/eschrock</span><br></pre></td></tr></table></figure></li></ul><h1 id="3-ZFS-snapshot"><a href="#3-ZFS-snapshot" class="headerlink" title="3. ZFS snapshot"></a>3. ZFS snapshot</h1><ul><li>文件系统的只读副本<br>即时创建、数量不限,不占用额外空间 - 块仅在发生更改时才会被复制<br>可通过每个文件系统根目录下的 .zfs&#x2F;snapshot 访问<br>使用户可在没有系统管理员介入的情况下恢复文件<br>对用户Ａ 的起始目录执行快照捕获<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs snapshot tank/home/usera@tuesday</span><br></pre></td></tr></table></figure></li><li>回滚到前一个快照<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs rollback tank/home/usera@monday</span><br></pre></td></tr></table></figure></li><li>查看星期三的 foo.c 版本<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat /tank/home/usera/.zfs/snapshot/wednesday/foo.c</span><br></pre></td></tr></table></figure></li><li>删除快照<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs destroy -R tank/home/usera@monday</span><br></pre></td></tr></table></figure></li></ul><h1 id="4-ZFS-Clone"><a href="#4-ZFS-Clone" class="headerlink" title="4. ZFS Clone"></a>4. ZFS Clone</h1><ul><li><p>快照的可写副本<br>即时创建、数量不限<br>存储大部分为共享数据的众多专用副本的理想方法<br>软件安装<br>工作区<br>无盘客户机</p></li><li><p>创建 OpenSolaris 源代码的克隆</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs clone tank/solaris@monday tank/ws/lori/fix</span><br></pre></td></tr></table></figure></li></ul><h1 id="5-ZFS-send-x2F-receive"><a href="#5-ZFS-send-x2F-receive" class="headerlink" title="5. ZFS send&#x2F;receive"></a>5. ZFS send&#x2F;receive</h1><ul><li><p>基于快照点<br>完整备份：任何快照<br>增量备份：任何快照增量<br>速度很快 - 开销与更改的数据成比例<br>非常高效，可执行远程复制</p></li><li><p>生成完整备份</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs send tank/fs@A &gt;/backup/A    </span><br></pre></td></tr></table></figure></li><li><p>生成增量备份</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs send -i tank/fs@A tank/fs@B &gt;/backup/B-A</span><br></pre></td></tr></table></figure></li><li><p>远程复制：每分钟发送一次增量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs send -i tank/fs@11:31 tank/fs@11:32 | ssh host zfs receive -d /tank/fs</span><br></pre></td></tr></table></figure></li></ul><h1 id="6-ZFS-数据迁移"><a href="#6-ZFS-数据迁移" class="headerlink" title="6. ZFS 数据迁移"></a>6. ZFS 数据迁移</h1><ul><li><p>独立于主机的磁盘格式<br>将服务器从 x86 更改为 SPARC，也能运行<br>自适应字节存储顺序 (Adaptive endianness)：在两个平台上都无需额外成本<br>写入总是使用本地字节存储顺序 (native endianness)，在块指针中设置位<br>仅当主机字节存储顺序 (endianness) !&#x3D; 块字节存储顺序时，才会针对读取进行字节交换</p></li><li><p>ZFS 负责所有处理<br>无需考虑设备路径、配置文件、&#x2F;etc&#x2F;vfstab 等等<br>ZFS 会在必要时进行共享&#x2F;取消共享、挂载&#x2F;取消挂载等等</p></li><li><p>从旧服务器上导出池tank</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">old# zpool export tank</span><br></pre></td></tr></table></figure></li><li><p>物理移动磁盘并将池导入到新服务器中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new# zpool import tank</span><br></pre></td></tr></table></figure></li></ul><h1 id="7-设备管理"><a href="#7-设备管理" class="headerlink" title="7. 设备管理"></a>7. 设备管理</h1><ul><li><p>添加&#x2F;替换新设备 (type: ,mirror,raidz,raidz2,raidz3)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># zpool add tank &lt;type&gt; c0t2d0 c0t3d0 c0t4d0</span><br><span class="line"></span><br><span class="line"># zpool replace tank c0t1d0 c0t2d0</span><br></pre></td></tr></table></figure></li><li><p>添加&#x2F;移除镜像设备</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># zpool attach tank c0t1d0 c0t2d0</span><br><span class="line"># zpool detach tank c0t2d0</span><br></pre></td></tr></table></figure></li><li><p>将设备停止或手工启动 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># zpool offline tank c0t2d0</span><br><span class="line"># zpool online tank c0t2d0</span><br></pre></td></tr></table></figure></li><li><p>查看存储池当前状态和 I&#x2F;O 状况</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># zpool status -v tank</span><br><span class="line"># zpool iostat tank 1</span><br></pre></td></tr></table></figure></li><li><p>添加热备设备</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zpool add tank spare c0t2d0</span><br></pre></td></tr></table></figure></li><li><p>指定热备启动&#x2F;停止热备</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># zpool replace tank c0t1d0 c0t2d0</span><br><span class="line"># zpool detach tank c0t2d0</span><br></pre></td></tr></table></figure></li><li><p>将热备设备删除</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zpool remove tank c0t2d0</span><br></pre></td></tr></table></figure></li><li><p>添加&#x2F;删除独立的日志设备（性能改善）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># zpool add tank log c0t3d0</span><br><span class="line"># zpool remove tank c0t3d0</span><br></pre></td></tr></table></figure></li></ul><h1 id="8-ZFS-权限管理"><a href="#8-ZFS-权限管理" class="headerlink" title="8. ZFS 权限管理"></a>8. ZFS 权限管理</h1><ul><li><p>可以将zfs(1M) 的管理权限分派给普通用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">      &#x27;zfs allow&#x27;</span><br><span class="line">      &#x27;zfs unallow&#x27;</span><br></pre></td></tr></table></figure></li><li><p>将权限授予一个普通用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs allow marks create,snapshot tank/marks</span><br></pre></td></tr></table></figure></li><li><p>将指定权限回收</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs unallow marks create,snapshot tank/marks</span><br></pre></td></tr></table></figure></li><li><p>查看文件系统当前的权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs allow tank/marks</span><br></pre></td></tr></table></figure></li></ul><h1 id="9-其它命令"><a href="#9-其它命令" class="headerlink" title="9. 其它命令"></a>9. 其它命令</h1><ul><li>显示存储池所有操作历史记录<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zpool history tank</span><br></pre></td></tr></table></figure></li><li>升级存储池到指定 SPA 版本<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zpool upgrade -V &lt;version&gt; tank</span><br></pre></td></tr></table></figure></li><li>升级文件系统到指定 ZPL 版本<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># zfs upgrade -V &lt;version&gt; tank/fs</span><br></pre></td></tr></table></figure></li><li>手工挂载&#x2F;卸载文件系统<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># zfs mount -a</span><br><span class="line"># zfs unmount tank/fs</span><br><span class="line"># zfs unmount -a</span><br></pre></td></tr></table></figure></li></ul><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://chegva.com/1337.html">ZFS常用命令</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-创建pool和ZFS文件系统&quot;&gt;&lt;a href=&quot;#1-创建pool和ZFS文件系统&quot; class=&quot;headerlink&quot; title=&quot;1. 创建pool和ZFS文件系统&quot;&gt;&lt;/a&gt;1. 创建pool和ZFS文件系统&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;创建名</summary>
      
    
    
    
    <category term="ZFS" scheme="https://kenryu.cc/categories/ZFS/"/>
    
    
    <category term="Server" scheme="https://kenryu.cc/tags/Server/"/>
    
    <category term="ZFS" scheme="https://kenryu.cc/tags/ZFS/"/>
    
    <category term="Storage" scheme="https://kenryu.cc/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>Setup WebDAV server (Apache)</title>
    <link href="https://kenryu.cc/2021/12/15/File_Sharing_Servers/Setup_WebDAV_server__Apache_/"/>
    <id>https://kenryu.cc/2021/12/15/File_Sharing_Servers/Setup_WebDAV_server__Apache_/</id>
    <published>2021-12-15T12:17:52.000Z</published>
    <updated>2022-06-30T00:45:55.810Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Premise"><a href="#Premise" class="headerlink" title="Premise"></a>Premise</h1><ul><li>Installed <strong>Apache</strong> .</li><li>Installed SSL&#x2F;TLS server <strong>Private key &amp; Certificate</strong>.</li><li>Disabled SELinux.</li><li>Allowed Firewall.</li></ul><h1 id="Enviroment"><a href="#Enviroment" class="headerlink" title="Enviroment"></a>Enviroment</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel8 ~]# cat /etc/redhat-release</span><br><span class="line">Red Hat Enterprise Linux release 8.5 (Ootpa)</span><br><span class="line">[root@rhel8 ~]# httpd -v</span><br><span class="line">Server version: Apache/2.4.37 (Red Hat Enterprise Linux)</span><br><span class="line">Server built: Oct 26 2021 14:18:06</span><br><span class="line">[root@rhel8 ~]# smbstatus --version</span><br><span class="line">Version 4.14.5</span><br></pre></td></tr></table></figure><h1 id="Make-Share-Folder"><a href="#Make-Share-Folder" class="headerlink" title="Make Share Folder"></a>Make Share Folder</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /share</span><br><span class="line">chmod -R 775 /share</span><br><span class="line">chown -R apache. /share</span><br></pre></td></tr></table></figure><h1 id="Configure-WebDAV"><a href="#Configure-WebDAV" class="headerlink" title="Configure WebDAV"></a>Configure WebDAV</h1><h3 id="Create-new-config-file-follwing"><a href="#Create-new-config-file-follwing" class="headerlink" title="Create new config file follwing:"></a>Create new config file follwing:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf.d/webdav.conf</span><br><span class="line"></span><br><span class="line"># create new</span><br><span class="line">&lt;IfModule mod_dav_fs.c&gt;</span><br><span class="line">DAVLockDB /var/lib/dav/lockdb</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line">Alias /share /share</span><br><span class="line">&lt;Location /share&gt;</span><br><span class="line">DAV On</span><br><span class="line">SSLRequireSSL</span><br><span class="line">Options None</span><br><span class="line">AuthType Basic</span><br><span class="line">AuthName WebDAV</span><br><span class="line">AuthUserFile /etc/httpd/conf/.htpasswd</span><br><span class="line">&lt;RequireAny&gt;</span><br><span class="line">Require method GET POST OPTIONS</span><br><span class="line">Require valid-user</span><br><span class="line">&lt;/RequireAny&gt;</span><br><span class="line">&lt;/Location&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Create-WebDAV-User"><a href="#Create-WebDAV-User" class="headerlink" title="Create WebDAV User"></a>Create WebDAV User</h3><blockquote><p>Note: This user is not your operating system’s user.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -c /etc/httpd/conf/.htpasswd &lt;InputYourUserName&gt;</span><br><span class="line">New password: &lt;InputYourPassword&gt;</span><br><span class="line">Re-type new password: &lt;InputYourPassword&gt;</span><br><span class="line">Adding password for user &lt;HereIsYourUserName&gt;</span><br></pre></td></tr></table></figure><h3 id="Optional-Edit-Apache-run-user"><a href="#Optional-Edit-Apache-run-user" class="headerlink" title="(Optional) Edit Apache run user"></a><del>(Optional) Edit Apache run user</del></h3><p>It doesn’t work.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf/httpd.conf</span><br><span class="line"></span><br><span class="line">69 #User apache</span><br><span class="line">70 #Group apache</span><br><span class="line">71 User cjl</span><br><span class="line">72 Group cjl</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Start-Apache"><a href="#Start-Apache" class="headerlink" title="Start Apache"></a>Start Apache</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now httpd</span><br></pre></td></tr></table></figure><h1 id="Optional-Configure-SMB"><a href="#Optional-Configure-SMB" class="headerlink" title="(Optional) Configure SMB"></a>(Optional) Configure SMB</h1><p>When we want SMB to coexist with WebDAV.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/samba/smb.conf</span><br><span class="line"></span><br><span class="line">[global]</span><br><span class="line">workgroup = WORKGROUP</span><br><span class="line">security=user</span><br><span class="line">map to guest =Bad User</span><br><span class="line"></span><br><span class="line">#添加名为share的共享文件夹</span><br><span class="line">[share]</span><br><span class="line">comment = share all</span><br><span class="line">path = /share</span><br><span class="line">browseable = yes</span><br><span class="line">public = yes</span><br><span class="line">writable = yes</span><br><span class="line">create mode = 0744</span><br><span class="line">force create mode = 0744</span><br><span class="line">directory mode = 0744</span><br><span class="line">force directory mode = 0744</span><br><span class="line">force user = apache</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart smb</span><br></pre></td></tr></table></figure><h1 id="WebDAV-Client"><a href="#WebDAV-Client" class="headerlink" title="WebDAV Client"></a>WebDAV Client</h1><h2 id="Windows11"><a href="#Windows11" class="headerlink" title="Windows11"></a>Windows11</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use W: https://192.168.64.84:10443/share /user:cjh Passw0rd</span><br></pre></td></tr></table></figure><blockquote><p>注：此时该使用率为 C 盘使用率</p></blockquote><p><img src="/resources/c66e506b80dc4c7696a76e2d002a2f72.png" alt="93f97ccc15849f38f8bc1e02178d4b98.png"></p><p><img src="/resources/4c10e6a842fd4da0bb434d30eeeb9122.png" alt="48b98cb67ab001de8adead97de6605f4.png"></p><p><img src="/resources/56645ff907b0427fb4dcbd2cc397ef12.png" alt="0e185d4f4e020542ea4470cbb2879782.png"><br><img src="/resources/d7271438ef97408e953e8cf3ee39777f.png" alt="91c59f85f40de20ac4df8b55650b5d99.png"><br>]</p><h1 id="免密码登录"><a href="#免密码登录" class="headerlink" title="免密码登录"></a>免密码登录</h1><blockquote><p>参考：<a href="https://httpd.apache.org/docs/2.4/mod/mod_dav.html">https://httpd.apache.org/docs/2.4/mod/mod_dav.html</a></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf.d/webdav.conf</span><br><span class="line"></span><br><span class="line"># create new</span><br><span class="line">DAVLockDB /var/lib/dav/lockdb</span><br><span class="line">Alias /share /share</span><br><span class="line">&lt;Directory &quot;/share&quot;&gt;</span><br><span class="line">Require all granted</span><br><span class="line">Dav On</span><br><span class="line"></span><br><span class="line">AuthType Basic</span><br><span class="line">AuthName DAV</span><br><span class="line">AuthUserFile &quot;user.passwd&quot;</span><br><span class="line"></span><br><span class="line">&lt;LimitExcept GET POST OPTIONS&gt;</span><br><span class="line">Require user admin</span><br><span class="line">&lt;/LimitExcept&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Premise&quot;&gt;&lt;a href=&quot;#Premise&quot; class=&quot;headerlink&quot; title=&quot;Premise&quot;&gt;&lt;/a&gt;Premise&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;Installed &lt;strong&gt;Apache&lt;/strong&gt; .&lt;/li&gt;
&lt;li</summary>
      
    
    
    
    <category term="File Sharing Servers" scheme="https://kenryu.cc/categories/File-Sharing-Servers/"/>
    
    
  </entry>
  
  <entry>
    <title>SMART Monitoring Tools</title>
    <link href="https://kenryu.cc/2021/12/11/Storage/SMART_Monitoring_Tools/"/>
    <id>https://kenryu.cc/2021/12/11/Storage/SMART_Monitoring_Tools/</id>
    <published>2021-12-11T03:09:02.000Z</published>
    <updated>2022-07-01T01:10:58.403Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><ul><li>Self-Monitoring, Analysis and Reporting Technology.</li><li>Logging SMART errors and changes via the SYSLOG interface.</li><li>Send email warnings if problems are detected.</li><li>Make HDD enclosure LED blinking.</li></ul><h1 id="Descriptions"><a href="#Descriptions" class="headerlink" title="Descriptions"></a>Descriptions</h1><h2 id="smartmontools"><a href="#smartmontools" class="headerlink" title="smartmontools"></a>smartmontools</h2><p>smartctl controls the Self-Monitoring, Analysis and Reporting Technology (SMART) system built into most ATA&#x2F;SATA and SCSI&#x2F;SAS hard drives and solid-state drives. The purpose of SMART is to monitor the reliability of the hard drive and predict drive failures, and to carry out different types of drive self-tests. smartctl also supports some features not related to SMART. This version of smartctl is compatible with ACS-3, ACS-2, ATA8-ACS, ATA&#x2F;ATAPI-7 and earlier standards (see REFERENCES below).</p><h2 id="ledmon"><a href="#ledmon" class="headerlink" title="ledmon"></a>ledmon</h2><p>The ledctl is an user space application designed to control LEDs associated with each slot in an enclosure or a drive bay. The LEDs of devices listed in list_of_devices are set to the given pattern pattern_name and all other LEDs are turned off. User must have root privileges to use this application.</p><h1 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h1><p>Install SMART monitor tool and set it to start automatically when OS start-up.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf -y install smartmontools</span><br><span class="line">systemctl enable --now ledmon.service</span><br></pre></td></tr></table></figure><p>Install LED’s controller tool and set it to start automatically when OS start-up.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf -y install ledmon</span><br><span class="line">systemctl enable --now smartd.service</span><br></pre></td></tr></table></figure><h1 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h1><h2 id="smartmontools-1"><a href="#smartmontools-1" class="headerlink" title="smartmontools"></a>smartmontools</h2><p>Send Error massege via SMTP</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/smartmontools/smartd.conf</span><br><span class="line"></span><br><span class="line"># Specify SMTP server and accounds.</span><br></pre></td></tr></table></figure><h1 id="Maintenance"><a href="#Maintenance" class="headerlink" title="Maintenance"></a>Maintenance</h1><blockquote><p>Note: Not recommented to use &#x2F;dev&#x2F;sdX to specify HDD.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smartctl --scan</span><br><span class="line">smartctl /dev/sda -i</span><br></pre></td></tr></table></figure><p>The following example illustrates how to locate a single block device.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ledctl locate=/dev/disk/by-id/wwn-0x5000039b0810bcd9</span><br></pre></td></tr></table></figure><p>The following example illustrates how to turn Locate LED off for the same block device.</p><pre><code>ledctl locate_off=/dev/disk/by-id/wwn-0x5000039b0810bcd9</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Objectives&quot;&gt;&lt;a href=&quot;#Objectives&quot; class=&quot;headerlink&quot; title=&quot;Objectives&quot;&gt;&lt;/a&gt;Objectives&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;Self-Monitoring, Analysis and Re</summary>
      
    
    
    
    <category term="Storage" scheme="https://kenryu.cc/categories/Storage/"/>
    
    
    <category term="linux" scheme="https://kenryu.cc/tags/linux/"/>
    
    <category term="server" scheme="https://kenryu.cc/tags/server/"/>
    
    <category term="storage" scheme="https://kenryu.cc/tags/storage/"/>
    
  </entry>
  
  <entry>
    <title>Deploy Nginx, MySQL, PHP on Linux (LEMP/LNMP stack)</title>
    <link href="https://kenryu.cc/2021/11/22/Linux/Deploy-Linux-Nginx-MySQL-PHP-Server/"/>
    <id>https://kenryu.cc/2021/11/22/Linux/Deploy-Linux-Nginx-MySQL-PHP-Server/</id>
    <published>2021-11-21T15:00:00.000Z</published>
    <updated>2022-06-30T00:45:55.810Z</updated>
    
    <content type="html"><![CDATA[<table><thead><tr><th>Name</th><th>Version</th><th>Command</th></tr></thead><tbody><tr><td>Linux</td><td>Rocky Linux release 8.5 (Green Obsidian)</td><td>cat &#x2F;etc&#x2F;os-release &#x2F;etc&#x2F;redhat-release &#x2F;etc&#x2F;system-release</td></tr><tr><td>Nginx</td><td>nginx version: nginx&#x2F;1.20.2</td><td>nginx -v</td></tr><tr><td>MySQL</td><td>mysql Ver 8.0.28 for Linux on x86_64 (MySQL Community Server - GPL)</td><td>mysql –version</td></tr><tr><td>PHP</td><td>PHP 7.4.29 (cli) (built: Apr 12 2022 10:55:38) ( NTS )</td><td>php -v</td></tr></tbody></table><h1 id="0-Preparation"><a href="#0-Preparation" class="headerlink" title="0. Preparation"></a>0. Preparation</h1><p>Check if old packages have been installed.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># rpm -qa | grep -E &quot;nginx|php|mariadb&quot;</span><br></pre></td></tr></table></figure><p>If they are installed, remove them.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># yum remove -y &quot;nginx*&quot;</span><br><span class="line"># yum remove -y &quot;php*&quot;</span><br><span class="line"># yum remove -y &quot;mariadb*&quot;</span><br></pre></td></tr></table></figure><h1 id="1-Add-repositories"><a href="#1-Add-repositories" class="headerlink" title="1. Add repositories"></a>1. Add repositories</h1><h3 id="1-1-Add-Nginx-Official-repository"><a href="#1-1-Add-Nginx-Official-repository" class="headerlink" title="1.1 Add Nginx Official repository"></a>1.1 Add Nginx Official repository</h3><p>Create and edit the following file.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/yum.repos.d/nginx.repo</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[nginx]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch</span><br><span class="line">gpgcheck=1</span><br><span class="line">enable=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># yum-config-manager --enable nginx</span><br><span class="line"># dnf config-manager --enable nginx</span><br></pre></td></tr></table></figure><h3 id="1-2-Add-MySQL-Official-repositories"><a href="#1-2-Add-MySQL-Official-repositories" class="headerlink" title="1.2 Add MySQL Official repositories"></a>1.2 Add MySQL Official repositories</h3><p>Download and install repositories form : <a href="https://dev.mysql.com/downloads/repo/yum/">MySQL Community Downloads</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># dnf -y install https://repo.mysql.com//mysql80-community-release-el8-3.noarch.rpm</span><br><span class="line"># dnf config-manager --enable mysql80-community</span><br><span class="line"># yum repolist all | grep mysql</span><br></pre></td></tr></table></figure><h3 id="1-3-Add-PHP-repository"><a href="#1-3-Add-PHP-repository" class="headerlink" title="1.3 Add PHP repository"></a>1.3 Add PHP repository</h3><p>Execute the following commands in sequence to add and update epel repository.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># dnf install -y https://rpms.remirepo.net/enterprise/remi-release-8.rpm</span><br><span class="line"># dnf module enable php:remi-7.4 -y</span><br></pre></td></tr></table></figure><h1 id="2-Installation"><a href="#2-Installation" class="headerlink" title="2. Installation"></a>2. Installation</h1><h2 id="2-1-Install-Nginx"><a href="#2-1-Install-Nginx" class="headerlink" title="2.1 Install Nginx"></a>2.1 Install Nginx</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># dnf -y install nginx</span><br><span class="line"># nginx -v</span><br></pre></td></tr></table></figure><h2 id="2-2-Install-MySQL"><a href="#2-2-Install-MySQL" class="headerlink" title="2.2 Install MySQL"></a>2.2 Install MySQL</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># yum module disable mysql -y</span><br><span class="line"># yum install mysql-community-server -y</span><br><span class="line"># mysql -V</span><br></pre></td></tr></table></figure><h2 id="2-3-Install-PHP"><a href="#2-3-Install-PHP" class="headerlink" title="2.3 Install PHP"></a>2.3 Install PHP</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># dnf install php php-curl php-dom php-exif php-fileinfo php-fpm php-gd php-hash php-json php-mbstring php-mysqli php-openssl php-pcre php-xml libsodium php-ldap php-pdo php-pear php-snmp php-xml -y</span><br><span class="line"># php -v</span><br></pre></td></tr></table></figure><h1 id="3-Configuration"><a href="#3-Configuration" class="headerlink" title="3. Configuration"></a>3. Configuration</h1><h2 id="3-1-Configure-Nginx"><a href="#3-1-Configure-Nginx" class="headerlink" title="3.1 Configure Nginx"></a>3.1 Configure Nginx</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl enable --now nginx</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.bak</span><br><span class="line"># vim default.conf</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">root /usr/share/nginx/html;</span><br><span class="line">- index index.html index.htm;</span><br><span class="line">+ index index.html index.htm index.php;</span><br><span class="line">&#125;</span><br><span class="line">location ~ .php$ &#123;</span><br><span class="line">root /usr/share/nginx/html;</span><br><span class="line">fastcgi_pass unix:/run/php-fpm/www.sock;</span><br><span class="line">fastcgi_index index.php;</span><br><span class="line">fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">include fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line">## Edit this file according to actual usage.</span><br></pre></td></tr></table></figure><h2 id="3-2-Configure-MySQL"><a href="#3-2-Configure-MySQL" class="headerlink" title="3.2 Configure MySQL"></a>3.2 Configure MySQL</h2><p>Start and set enabled the MySQL server</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl enable --now mysqld</span><br></pre></td></tr></table></figure><p>A superuser account ‘root‘@’localhost’ is created. A password for the superuser is set and stored in the error log file. To reveal it, use the following command:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># grep &#x27;temporary password&#x27; /var/log/mysqld.log</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mysql -uroot -p</span><br><span class="line">mysql&gt; ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;Your_Password&#x27;;</span><br></pre></td></tr></table></figure><blockquote><p>MySQL’s validate_password plugin is installed by default. This will require that passwords contain at least one uppercase letter, one lowercase letter, one digit, and one special character, and that the total password length is at least 8 characters.</p></blockquote><blockquote><p>Reference site<br><a href="https://dev.mysql.com/doc/mysql-yum-repo-quick-guide/en/">A Quick Guide to Using the MySQL Yum Repository</a></p></blockquote><h2 id="3-3-Configure-PHP"><a href="#3-3-Configure-PHP" class="headerlink" title="3.3 Configure PHP"></a>3.3 Configure PHP</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/php-fpm.d/www.conf</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- user = apache</span><br><span class="line">+ user = nginx</span><br><span class="line">- group = apache</span><br><span class="line">+ group = nginx</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># grep timezone /etc/php.ini</span><br><span class="line">; Defines the default timezone used by the date functions</span><br><span class="line">; http://php.net/date.timezone</span><br><span class="line">date.timezone = Asia/Tokyo</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl enable --now php-fpm</span><br></pre></td></tr></table></figure><hr><h2 id="Optional-Verify-environment-configuration"><a href="#Optional-Verify-environment-configuration" class="headerlink" title="(Optional) Verify environment configuration"></a>(Optional) Verify environment configuration</h2><p>Execute the following command to create test file.</p><blockquote><p>The root directory of the site that has been configured in <code>/usr/share/nginx/html</code>, This article uses thatdirectory as an example.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># echo &quot;&lt;?php phpinfo(); ?&gt;&quot; &gt;&gt; /usr/share/nginx/html/index.php</span><br><span class="line"># nginx -t</span><br><span class="line"># nginx -s reload</span><br></pre></td></tr></table></figure><p>Modify the firewall policy to make the server can be accessed.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --permanent --add-port=&#123;443/tcp,80/tcp&#125;</span><br><span class="line"># firewall-cmd --reload</span><br></pre></td></tr></table></figure><p>Access the following address in your browser.<br><a href="http://your_lnmp_server_ip/">http://your_lnmp_server_ip</a><br><img src="/resources/a00140617cff48c9ab2405d7a47ee3fc.png" alt="74cf5cec9ade58f2fb87e6003d42c459.png"><br><a href="http://your_lnmp_server_ip/index.php">http://your_lnmp_server_ip/index.php</a><br><img src="/resources/52ae4c9828d54beebfd2f823ba64d346.png" alt="4a5b21722700b65b44b39fde5379768e.png"></p><p>If the results are displayed as above, the environment is successfully configured.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Name&lt;/th&gt;
&lt;th&gt;Version&lt;/th&gt;
&lt;th&gt;Command&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;Linux&lt;/td&gt;
&lt;td&gt;Rocky Linux release 8.5 (</summary>
      
    
    
    
    <category term="Linux" scheme="https://kenryu.cc/categories/Linux/"/>
    
    
    <category term="Server" scheme="https://kenryu.cc/tags/Server/"/>
    
    <category term="Nginx" scheme="https://kenryu.cc/tags/Nginx/"/>
    
    <category term="MySQL" scheme="https://kenryu.cc/tags/MySQL/"/>
    
    <category term="PHP" scheme="https://kenryu.cc/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>搭建OpenVPN Over FRP</title>
    <link href="https://kenryu.cc/2021/10/31/Network/%E6%90%AD%E5%BB%BAOpenVPN_Over_FRP/"/>
    <id>https://kenryu.cc/2021/10/31/Network/%E6%90%AD%E5%BB%BAOpenVPN_Over_FRP/</id>
    <published>2021-10-31T05:08:47.000Z</published>
    <updated>2022-06-30T00:45:55.820Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在学校或者公司外部的，或者出差在外地，想访问学校或者公司内网的服务器，但是没用网络管理员的权限，或者网络管理员不配合设定的情况下，如何突破NAT网络防火墙，达到访问内部网络。这是搭建这个服务的目的。</p><p>关于frp</p><blockquote><p>A fast reverse proxy to help you expose a local server behind a NAT or firewall to the internet. <a href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a></p></blockquote><p>它是一个反向代理程序。它可以将借助存在于公网上的代理服务器，中继 NAT 和防火墙后面的服务，实现内网穿透（NAT Traversal、ファイアウォール透過＆貫通）的一种手段。</p><p><img src="/resources/eade905969e34b7f9deed26d8a9c6dd0.png" alt="Openvpn over frp.png"></p><p>在接下来搭建好的Proxy服务器中，sockstat命令（摘录；考虑隐私公网IP随便写的）中可以了解到：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[2.5.2-RELEASE][root@Proxy]/root: sockstat | grep frp</span><br><span class="line"></span><br><span class="line"># 监听7000端口</span><br><span class="line">root frps 67615 3 tcp46 *:7000 *:*</span><br><span class="line"># 在内网的Proxy Server经过路由NAT转换之后的公网IP与Proxy Server进行了连接</span><br><span class="line">root frps 67615 11 tcp4 110.120.119.1:7000 119.120.110.1:61662</span><br><span class="line"># 监听6000端口（SSH服务）</span><br><span class="line">root frps 67615 10 tcp46 *:6000 *:*</span><br><span class="line"># 接受了客户端的连接</span><br><span class="line">root frps 67615 14 tcp4 110.120.119.1:6000 192.168.10.10:68623</span><br><span class="line"># 监听1194端口（OpenVPN服务）</span><br><span class="line">root frps 67615 9 tcp46 *:1194 *:*</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Client与Proxy建立连接，Reverse Proxy也与Proxy建立连接，通过这种围魏救赵的方式实现Client与Reverse Proxy建立连接。</p><p>以下是使用frp反向代理openvpn突破防火墙的一个demo。</p><h1 id="0-demo环境"><a href="#0-demo环境" class="headerlink" title="0. demo环境"></a>0. demo环境</h1><table><thead><tr><th>Host</th><th>OS</th><th>Service</th><th>IP</th><th>Allow Port (Inbound)</th></tr></thead><tbody><tr><td>Reverse Proxy Server</td><td>CentOS Linux release 8.4.2105</td><td>frpc (frp_0.38.0_linux_amd64), openvpn</td><td>P:172.16.10.10 (G:119.120.110.1)</td><td>&#x2F;</td></tr><tr><td>Proxy Server</td><td>FreeBSD 12.2-STABLE</td><td>frps (frp_0.38.0_freebsd_amd64)</td><td>110.120.119.1</td><td>#7000(from RPS) &amp; #6000(from client) &amp; #1194(from client)</td></tr><tr><td>Client</td><td>macOS</td><td>openvpn-client</td><td>192.168.10.10</td><td>&#x2F;</td></tr></tbody></table><p><em>OS基本可以无视，因为不管是frp或者OpenVPN基本全平台适配</em></p><h1 id="1-部署Reverse-Proxy-Server"><a href="#1-部署Reverse-Proxy-Server" class="headerlink" title="1. 部署Reverse Proxy Server"></a>1. 部署Reverse Proxy Server</h1><p>在想要突破的内网环境（公司，学校）的机器上安装必要的frp，和其他服务这里用openvpn演示。防火墙策略允许outbound。</p><h2 id="1-1-部署frpc"><a href="#1-1-部署frpc" class="headerlink" title="1.1 部署frpc"></a>1.1 部署frpc</h2><p>目前可以在 Github 的 Release 页面中下载到最新版本的二进制文件。 <a href="https://github.com/fatedier/frp/releases/">https://github.com/fatedier/frp/releases/</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="1-1-1-解压安装包"><a href="#1-1-1-解压安装包" class="headerlink" title="1.1.1 解压安装包"></a>1.1.1 解压安装包</h2><p>解压缩下载的压缩包， 放置在任意目录。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf frp_0.38.0_linux_amd64.tar.gz</span><br><span class="line">cd frp_0.38.0_linux_amd64</span><br></pre></td></tr></table></figure><blockquote><p>这里（Reverse Proxy Server）上只用到frpc相关的文件，frps用不到。</p></blockquote><h2 id="1-1-2-配置以及启动服务"><a href="#1-1-2-配置以及启动服务" class="headerlink" title="1.1.2 配置以及启动服务"></a>1.1.2 配置以及启动服务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ServerC /]# cat frpc.ini</span><br><span class="line">[common]</span><br><span class="line">server_addr = 110.120.119.1 # Proxy Server的公网IP</span><br><span class="line">server_port = 7000 # Proxy Server上的frps监听frpc连接的端口</span><br><span class="line"></span><br><span class="line">[ssh]</span><br><span class="line">type = tcp</span><br><span class="line">local_ip = 127.0.0.1 # 指向本机IP</span><br><span class="line">local_port = 22 # 指向本机的SSH端口</span><br><span class="line">remote_port = 6000 # Proxy Server监听的端口。之后Client可以通过访问Proxy Server的6000端口，端口转发到上面的本机端口</span><br></pre></td></tr></table></figure><p>通过 <code> ./frpc -c ./frpc.ini &amp;</code> 启动服务端。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@cjl-docker frp_0.37.1_linux_amd64]# ./frpc -c ./frpc.ini</span><br><span class="line">2021/08/25 00:00:40 [I] [service.go:304] [a0e6112664ab2527] login to server success, get run id [a0e6112664ab2527], server udp port [0]</span><br><span class="line">2021/08/25 00:00:40 [I] [proxy_manager.go:144] [a0e6112664ab2527] proxy added: [ssh]</span><br><span class="line">2021/08/25 00:00:40 [I] [control.go:180] [a0e6112664ab2527] [ssh] start proxy success</span><br></pre></td></tr></table></figure><p>如果需要在后台长期运行，建议结合其他工具使用，例如 systemd 和 supervisor。</p><h2 id="1-1-3-部署openvpn"><a href="#1-1-3-部署openvpn" class="headerlink" title="1.1.3 部署openvpn"></a>1.1.3 部署openvpn</h2><p>这里不做演示了，详细请参阅搭建openvpn教程。</p><blockquote><p><a href="https://www.gingerdoc.com/tutorials/how-to-set-up-and-configure-an-openvpn-server-on-centos-8">如何在 CentOS 8 上设置和配置 OpenVPN 服务器</a></p></blockquote><h1 id="2-搭建Proxy-Server"><a href="#2-搭建Proxy-Server" class="headerlink" title="2. 搭建Proxy Server"></a>2. 搭建Proxy Server</h1><p>在用有公网IP的机器安装frps服务，设定好防火墙。<br>这里用的是FreeBSD，公网IP为110.120.119.1，防火墙策略为：允许来自Reverse Proxy Server公网IP的连接，和允许来自Client的连接。</p><h2 id="2-1-下载安装包"><a href="#2-1-下载安装包" class="headerlink" title="2.1 下载安装包"></a>2.1 下载安装包</h2><p>目前可以在 Github 的 Release 页面中下载到最新版本的客户端和服务端二进制文件，所有文件被打包在一个压缩包中。 <a href="https://github.com/fatedier/frp/releases/tag/v0.37.1">https://github.com/fatedier/frp/releases/tag/v0.37.1</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/fatedier/frp/releases/download/v0.37.1/frp_0.37.1_linux_amd64.tar.gz</span><br></pre></td></tr></table></figure><h2 id="2-2-解压安装包"><a href="#2-2-解压安装包" class="headerlink" title="2.2 解压安装包"></a>2.2 解压安装包</h2><p>解压缩下载的压缩包，放置在任意目录。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf frp_0.37.1_linux_amd64.tar.gz</span><br></pre></td></tr></table></figure><blockquote><p>Proxy只用到frps。</p></blockquote><h2 id="2-3-配置文件以及启动服务"><a href="#2-3-配置文件以及启动服务" class="headerlink" title="2.3 配置文件以及启动服务"></a>2.3 配置文件以及启动服务</h2><p>编写配置文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat frp_0.37.1_linux_amd64/frps.ini</span><br><span class="line">---</span><br><span class="line">[common]</span><br><span class="line">bind_port = 7000</span><br></pre></td></tr></table></figure><p>通过 <code> ./frps -c ./frps.ini &amp;</code> 启动服务端，之后再通过 <code>ss -ntul</code> 查看是否开启监听7000端口。如果需要在后台长期运行，建议结合其他工具使用，例如 systemd 和 supervisor。</p><h2 id="2-4-配置防火墙"><a href="#2-4-配置防火墙" class="headerlink" title="2.4 配置防火墙"></a>2.4 配置防火墙</h2><ul><li>策略1：让Proxy的7000端口暴露在公网上，才能让Reverse Proxy经行握手连接。</li><li>策略2：6000端口要暴露给Client。</li></ul><blockquote><p>具体设置的话要根据情况不同，如果Proxy或者Client也经过NAT，路由或者防火墙的话，除了本机防火之外，路由器的防火墙也要设定。</p></blockquote><h1 id="3-测试以及使用"><a href="#3-测试以及使用" class="headerlink" title="3. 测试以及使用"></a>3. 测试以及使用</h1><h2 id="3-1-开启服务后进行端口扫描："><a href="#3-1-开启服务后进行端口扫描：" class="headerlink" title="3.1 开启服务后进行端口扫描："></a>3.1 开启服务后进行端口扫描：</h2><p>先开启frps，再开启frpc。当frpc连接上frps的时候，frps的6000号端口才会开启了监听。</p><h3 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h3><p>在线端口扫描<br><a href="https://www.cman.jp/network/support/go_port.cgi">https://www.cman.jp/network/support/go_port.cgi</a></p><h3 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h3><p>通过nmap工具端口扫描</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap -p 7000 110.120.119.1</span><br><span class="line">nmap -p 6000 110.120.119.1</span><br></pre></td></tr></table></figure><h2 id="3-2-开始使用"><a href="#3-2-开始使用" class="headerlink" title="3.2 开始使用"></a>3.2 开始使用</h2><p>Server A或者任意设备通过SSH访问Server B的6000端口，即可转发到Server C的22端口！</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh 110.120.119.1 -p 6000</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>内网服务器上部署frpc服务（可以设置为systemctl开机自启），与reverse proxy服务器frps建立握手连接，通过SSH访问frps的端口转发，最终达到访问frpc所在服务器的目的。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><blockquote></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;在学校或者公司外部的，或者出差在外地，想访问学校或者公司内网的服务器，但是没用网络管理员的权限，或者网络管理员不配合设定的情况下，如何突破N</summary>
      
    
    
    
    <category term="Network" scheme="https://kenryu.cc/categories/Network/"/>
    
    
    <category term="linux" scheme="https://kenryu.cc/tags/linux/"/>
    
    <category term="network" scheme="https://kenryu.cc/tags/network/"/>
    
    <category term="vpn" scheme="https://kenryu.cc/tags/vpn/"/>
    
  </entry>
  
  <entry>
    <title>SSL Certificates generation (On Linux use OpenSSL PKI)</title>
    <link href="https://kenryu.cc/2021/10/28/Security/SSL_Certificates_generation__On_Linux_use_OpenSSL_PKI_/"/>
    <id>https://kenryu.cc/2021/10/28/Security/SSL_Certificates_generation__On_Linux_use_OpenSSL_PKI_/</id>
    <published>2021-10-28T12:17:38.000Z</published>
    <updated>2022-06-30T00:45:55.820Z</updated>
    
    <content type="html"><![CDATA[<p>[toc]</p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p><img src="/resources/1fa2a2eab1bc40278d446a4d051bf8e7.png" alt="1449efa5e5facdd61663427a98e3a3a7.png"></p><h1 id="Definitons"><a href="#Definitons" class="headerlink" title="Definitons"></a>Definitons</h1><ul><li><p>PKI: Public Key Infrastructure<br>Security architecture where trust is conveyed through the signature of a trusted CA.</p></li><li><p>CA: Certificate Authority<br>Entity issuing certificates and CRLs.</p></li><li><p>TLS: 传输层安全协议 Transport Layer Security的缩写</p></li><li><p>SSL: 安全套接字层 Secure Socket Layer的缩写</p></li><li><p>KEY: 通常指私钥Private key。</p></li><li><p>CSR: 证书签名请求Certificate Signing Request的缩写，可以简单理解成公钥，生成证书时要把这个提交给权威的证书颁发机构。</p></li><li><p>CRT: 证书Certificate的缩写</p></li><li><p>CRL: 证书吊销列表 Certificate Revocation Lists的缩写。</p></li><li><p>X.509: 是一种证书格式。<br>对X.509证书来说，认证者总是CA或由CA指定的人，一份X.509证书是一些标准字段的集合，这些字段包含有关用户或设备及其相应公钥的信息。<br>X.509的证书文件，一般以.crt结尾，根据该文件的内容编码格式，可以分为以下二种格式：</p></li></ul><p>t- PEM (Privacy Enhanced Mail)文本格式,以”—BEGIN—“开头, “—END—“结尾,内容是BASE64编码。Apache和Nginx服务器偏向于使用这种编码格式.</p><p>t- DER (Distinguished Encoding Rules)二进制格式,不可读.Java和Windows服务器偏向于使用这种编码格式</p><p>OpenSSL 相当于SSL的一个实现，如果把SSL规范看成OO中的接口，那么OpenSSL则认为是接口的实现。接口规范本身是安全没问题的，但是具体实现可能会有不完善的地方，比如之前的”心脏出血”漏洞，就是OpenSSL中的一个bug.</p><h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><ul><li>You have set up OpenSSL on your machine.</li><li>You have established a process to sign trusted certificates. If you want to have the certificates signed by a certification authority, you have either established your own certification authority or you use an external certification authority. Alternatively, you can sign the generated certificate yourself.</li></ul><h1 id="Procedure"><a href="#Procedure" class="headerlink" title="Procedure"></a>Procedure</h1><h2 id="0-Edit-OpenSSL-conf-file"><a href="#0-Edit-OpenSSL-conf-file" class="headerlink" title="0. Edit OpenSSL conf file"></a>0. Edit OpenSSL <code>conf</code> file</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/pki/tls/</span><br><span class="line">cp openssl.cnf_org ca.conf</span><br><span class="line">vim ca.conf</span><br><span class="line"></span><br><span class="line">[ ca ]</span><br><span class="line">default_ca = CA_default #56行、何も変わらなかった</span><br><span class="line"></span><br><span class="line">[ CA_default ]</span><br><span class="line">...</span><br><span class="line">x509_extensions = usr_cert #76行、何も変わらなかった</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[ req ] #123行から</span><br><span class="line">default_bits = 2048</span><br><span class="line"># 125 default_md = sha256 #この行をコメントアウト</span><br><span class="line">default_keyfile = privkey.pem</span><br><span class="line">distinguished_name = req_distinguished_name</span><br><span class="line">attributes = req_attributes</span><br><span class="line">x509_extensions = v3_ca</span><br><span class="line">req_extensions = v3_req #130この行を追記</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[ usr_cert ]</span><br><span class="line">191 basicConstraints=CA:FALSE #コメントイン</span><br><span class="line">192 #basicConstraints=CA:TRUE #コメントアウト</span><br><span class="line"></span><br><span class="line">nsComment = &quot;OpenSSL Generated Certificate&quot; #212行、何も変わらなかった</span><br><span class="line"></span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">authorityKeyIdentifier=keyid,issuer:always #217行、最後の`:always`を追記</span><br><span class="line">subjectAltName = @alt_names #218行追記</span><br><span class="line"></span><br><span class="line">[ v3_req ]</span><br><span class="line">basicConstraints = CA:FALSE #244行、何も変わらなかった</span><br><span class="line">keyUsage = nonRepudiation, digitalSignature, keyEncipherment #245行、何も変わらなかった</span><br><span class="line">subjectAltName = @alt_names #246行、追記</span><br><span class="line"></span><br><span class="line">[alt_names] #このセクションは元々存在せず追記するもの</span><br><span class="line">DNS.1 = example.com</span><br><span class="line">DNS.2 = *.example.com</span><br><span class="line">IP.1 = 192.168.0.1</span><br><span class="line">IP.2 = 192.168.0.2</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>CSRを作る際</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[req] req_extensions = v3_req</span><br><span class="line">↓</span><br><span class="line">[v3_req] subjectAltName = @alt_names</span><br><span class="line">↓</span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1 = サーバのドメイン名</span><br><span class="line">IP.1 = サーバのIPアドレス</span><br></pre></td></tr></table></figure><p>といった流れで参照します。この設定ファイルを -config で指定して CSR を作ると、CSR に X509v3 Subject Alternative Name:エントリが入ります。</p><h2 id="1-Generate-Private-Key-amp-CSR"><a href="#1-Generate-Private-Key-amp-CSR" class="headerlink" title="1. Generate Private Key &amp; CSR"></a>1. Generate Private Key &amp; CSR</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -newkey rsa:2048 -nodes -sha256 \</span><br><span class="line">-subj &quot;/C=JP/ST=Saitama/L=Toda/O=Core Micro Systems, Inc./CN=cmsinc.co.jp/emailAddress=cjl@kensho.toda&quot; \</span><br><span class="line">-config server.conf \</span><br><span class="line">-keyout server.key \</span><br><span class="line">-out server.csr</span><br></pre></td></tr></table></figure><p>View CSR details</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -noout -text -in /etc/pki/tls/server.csr</span><br></pre></td></tr></table></figure><h2 id="2-Signing"><a href="#2-Signing" class="headerlink" title="2. Signing"></a>2. Signing</h2><ul><li>Submit the CSR to the certification authority.</li><li>Alternatively, sign the certificate yourself.</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openssl ca -batch \</span><br><span class="line">-keyfile /etc/pki/CA/private/cakey.pem \</span><br><span class="line">-days 365 \</span><br><span class="line">-config ca.conf \</span><br><span class="line">-in server.csr \</span><br><span class="line">-out server.crt</span><br></pre></td></tr></table></figure><p>View Certificate’s details</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -text -noout -in server.crt</span><br></pre></td></tr></table></figure><h1 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h1><h2 id="File-Convert"><a href="#File-Convert" class="headerlink" title="File Convert"></a>File Convert</h2><h3 id="1-Certificate"><a href="#1-Certificate" class="headerlink" title="1. Certificate"></a>1. Certificate</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -in kvm-bmc.crt -out kvm-bmc.pem</span><br></pre></td></tr></table></figure><h3 id="2-Key"><a href="#2-Key" class="headerlink" title="2. Key"></a>2. Key</h3><p>Public key or Private key</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rsa -in kvm-bmc.key -out kvm-bmc-private.pem</span><br></pre></td></tr></table></figure><h2 id="CAで発行したサーバ証明書を失効にする方法"><a href="#CAで発行したサーバ証明書を失効にする方法" class="headerlink" title="CAで発行したサーバ証明書を失効にする方法"></a>CAで発行したサーバ証明書を失効にする方法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl ca -revoke /etc/pki/CA/newcerts/xxx.pem #replacing the serial number</span><br></pre></td></tr></table></figure><h2 id="Trouble-Shooting"><a href="#Trouble-Shooting" class="headerlink" title="Trouble Shooting"></a>Trouble Shooting</h2><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote><ol><li><a href="https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs">OpenSSL Essentials: Working with SSL Certificates, Private Keys and CSRs</a></li><li><a href="https://tech.torico-corp.com/blog/chrome58-https-ssl-cert-san-error/">Chrome58で、HTTPSの自己証明書がNET::ERR_CERT_COMMON_NAME_INVALID になる場合の対応</a></li><li><a href="https://pki-tutorial.readthedocs.io/en/latest/#">OpenSSL PKI Tutorial </a></li><li><a href="https://www.golinuxcloud.com/tutorial-pki-certificates-authority-ocsp/">OpenSSL Certificate Manager</a></li></ol></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[toc]&lt;/p&gt;
&lt;h1 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/resour</summary>
      
    
    
    
    <category term="Security" scheme="https://kenryu.cc/categories/Security/"/>
    
    
  </entry>
  
  <entry>
    <title>Redmine搭建（PostgreSQL+Apache版）</title>
    <link href="https://kenryu.cc/2021/10/27/Redmine/Redmine%E6%90%AD%E5%BB%BA%EF%BC%88PostgreSQL+Apache%E7%89%88%EF%BC%89/"/>
    <id>https://kenryu.cc/2021/10/27/Redmine/Redmine%E6%90%AD%E5%BB%BA%EF%BC%88PostgreSQL+Apache%E7%89%88%EF%BC%89/</id>
    <published>2021-10-27T07:41:47.000Z</published>
    <updated>2022-06-30T00:45:55.820Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0-环境说明"><a href="#0-环境说明" class="headerlink" title="0. 环境说明"></a>0. 环境说明</h1><h3 id="Redmine需要的环境："><a href="#Redmine需要的环境：" class="headerlink" title="Redmine需要的环境："></a>Redmine需要的环境：</h3><ul><li>能运行Ruby的OS</li><li>数据库（MySQL &#x2F; PostgreSQL &#x2F; SQLite &#x2F; SQL服务器）</li><li>网站服务（Apache &#x2F; Nginx ）</li></ul><h3 id="本次搭建环境："><a href="#本次搭建环境：" class="headerlink" title="本次搭建环境："></a>本次搭建环境：</h3><table><thead><tr><th>Software</th><th>Version</th><th>Command</th></tr></thead><tbody><tr><td>OS</td><td>CentOS Linux release 8.4.2105</td><td>cat &#x2F;etc&#x2F;os-release &#x2F;etc&#x2F;redhat-release &#x2F;etc&#x2F;system-release</td></tr><tr><td>Redmine</td><td>4.2.3</td><td></td></tr><tr><td>Postgresql</td><td>postgres (PostgreSQL) 10.17</td><td>postgres -V</td></tr><tr><td>Ruby</td><td>ruby 2.5.9p229 (2021-04-05 revision 67939) [x86_64-linux]</td><td>ruby -v</td></tr><tr><td>Apache</td><td>Apache&#x2F;2.4.37 (centos)</td><td>apachectl -v</td></tr></tbody></table><h1 id="1-下载需要的软件包"><a href="#1-下载需要的软件包" class="headerlink" title="1. 下载需要的软件包"></a>1. 下载需要的软件包</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dnf -y update</span><br><span class="line">dnf -y groupinstall &quot;Development Tools&quot;</span><br><span class="line">dnf -y install vim wget tar openssl* httpd httpd-devel ruby ruby-devel libcurl-devel</span><br></pre></td></tr></table></figure><h1 id="2-安装数据库"><a href="#2-安装数据库" class="headerlink" title="2. 安装数据库"></a>2. 安装数据库</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf -y install postgresql-server postgresql-devel</span><br><span class="line">rpm -qa | grep postgresql</span><br></pre></td></tr></table></figure><p>初始化数据库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgresql-setup initdb</span><br></pre></td></tr></table></figure><p>开机自动启动</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now postgresql</span><br><span class="line">systemctl status postgresql</span><br></pre></td></tr></table></figure><p>创建redmine用户以及redmine数据库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# su - postgres</span><br><span class="line">[postgres@localhost ~]$ psql</span><br><span class="line">CREATE ROLE redmine LOGIN ENCRYPTED PASSWORD &#x27;Your_Password&#x27; NOINHERIT VALID UNTIL &#x27;infinity&#x27;;</span><br><span class="line">CREATE DATABASE redmine WITH ENCODING=&#x27;UTF8&#x27; OWNER=redmine;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\du #查看用户</span><br><span class="line">\l #查看数据库</span><br><span class="line">\q #退出</span><br></pre></td></tr></table></figure><p>编辑pg_hba.conf文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/pgsql/data/pg_hba.conf</span><br><span class="line"># configuration parameter, or via the -i or -h command line switches.</span><br><span class="line"></span><br><span class="line">host redmine redmine 127.0.0.1/32 md5</span><br><span class="line">host redmine redmine ::1/128 md5</span><br></pre></td></tr></table></figure><blockquote><p>注意：<br>添加的规则放在73行的: configuration parameter…下面。否则会出现<code>psql: FATAL: Ident authentication failed for user &quot;postgres&quot;</code> 的错误而且无法访问数据库的问题。</p></blockquote><p>重启数据库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart postgresql</span><br></pre></td></tr></table></figure><p>验证看看能不能正常访问数据库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">psql -U redmine -d redmine -h 127.0.0.1</span><br><span class="line">Password for user redmine: #←正常情况下会提示输入密码</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="3-关闭Selinux"><a href="#3-关闭Selinux" class="headerlink" title="3. 关闭Selinux"></a>3. 关闭Selinux</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/selinux/config</span><br><span class="line">#SELINUX=enforcing</span><br><span class="line"></span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br><span class="line">getenforce # 确认结果</span><br></pre></td></tr></table></figure><h1 id="4-下载安装Redmine"><a href="#4-下载安装Redmine" class="headerlink" title="4. 下载安装Redmine"></a>4. 下载安装Redmine</h1><blockquote><p>获取最新版本:<br><a href="https://www.redmine.org/projects/redmine/wiki/Download">Redmine官方下载地址</a></p></blockquote><h2 id="4-1-下载以及解压"><a href="#4-1-下载以及解压" class="headerlink" title="4.1. 下载以及解压"></a>4.1. 下载以及解压</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.redmine.org/releases/redmine-4.2.3.tar.gz</span><br><span class="line">tar -zxvf redmine-4.2.3.tar.gz</span><br><span class="line">mv redmine-4.2.3 /redmine</span><br></pre></td></tr></table></figure><h2 id="4-2-配置database-yml文件"><a href="#4-2-配置database-yml文件" class="headerlink" title="4.2. 配置database.yml文件"></a>4.2. 配置database.yml文件</h2><p>根据数据库设置，配置Redmine的连接数据库设定文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cd /redmine/config/</span><br><span class="line">cp database.yml.example database.yml</span><br><span class="line">vim database.yml</span><br><span class="line"></span><br><span class="line">###postgresql</span><br><span class="line">production:</span><br><span class="line">adapter: postgresql</span><br><span class="line">database: redmine</span><br><span class="line">host: localhost</span><br><span class="line">username: redmine</span><br><span class="line">password: &quot;Your_Password&quot;</span><br><span class="line">encoding: utf8</span><br><span class="line">t#pool: 5</span><br></pre></td></tr></table></figure><blockquote><p>注意：<br>要把development，test等区域给删了<br>排版缩进要正确！</p></blockquote><h2 id="4-3-通过Ruby部署"><a href="#4-3-通过Ruby部署" class="headerlink" title="4.3. 通过Ruby部署"></a>4.3. 通过Ruby部署</h2><p>我对Ruby不了解，这些命令不是很懂，似乎可以自动导入 Redmine 操作所需的 Ruby 软件包，为 MySQL 数据库创建所需的表或加载默认数据？注意不能忘了，在执行操作前移动到Redmine目录。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /redmine</span><br><span class="line">gem install bundler --no-rdoc --no-ri</span><br><span class="line">gem install bundler</span><br><span class="line">bundle install --without development test rmagick</span><br><span class="line">bundle exec rake generate_secret_token</span><br><span class="line">RAILS_ENV=production bundle exec rake db:migrate</span><br><span class="line">RAILS_ENV=production bundle exec rake redmine:load_default_data</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>执行最后一行的时候选择想要的语言。</p><h1 id="5-配置Apache"><a href="#5-配置Apache" class="headerlink" title="5. 配置Apache"></a>5. 配置Apache</h1><h2 id="5-1-安装passenger"><a href="#5-1-安装passenger" class="headerlink" title="5.1. 安装passenger"></a>5.1. 安装passenger</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gem install passenger</span><br><span class="line">passenger-install-apache2-module --auto --languages ruby</span><br></pre></td></tr></table></figure><p>有大量的日志在画面上滚动，需要花一点时间。虽然有很多警告，但是如果不因错误而掉落的话应该没什么问题。</p><h2 id="5-2-安装snippet"><a href="#5-2-安装snippet" class="headerlink" title="5.2. 安装snippet"></a>5.2. 安装snippet</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redmine]# passenger-install-apache2-module --snippet</span><br><span class="line">LoadModule passenger_module /usr/local/share/gems/gems/passenger-6.0.11/buildout/apache2/mod_passenger.so</span><br><span class="line">&lt;IfModule mod_passenger.c&gt;</span><br><span class="line">PassengerRoot /usr/local/share/gems/gems/passenger-6.0.11</span><br><span class="line">PassengerDefaultRuby /usr/bin/ruby</span><br><span class="line">&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure><h2 id="5-3-设置Redmine为Apache的根目录，并把上一步5-2的结果复制下来粘贴到redmine-conf文件中"><a href="#5-3-设置Redmine为Apache的根目录，并把上一步5-2的结果复制下来粘贴到redmine-conf文件中" class="headerlink" title="5.3. 设置Redmine为Apache的根目录，并把上一步5.2的结果复制下来粘贴到redmine.conf文件中"></a>5.3. 设置Redmine为Apache的根目录，并把上一步5.2的结果复制下来粘贴到redmine.conf文件中</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf.d/redmine.conf</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/redmine/public&quot;&gt;</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">LoadModule passenger_module /usr/local/share/gems/gems/passenger-6.0.11/buildout/apache2/mod_passenger.so</span><br><span class="line">&lt;IfModule mod_passenger.c&gt;</span><br><span class="line">PassengerRoot /usr/local/share/gems/gems/passenger-6.0.11</span><br><span class="line">PassengerDefaultRuby /usr/bin/ruby</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="5-4"><a href="#5-4" class="headerlink" title="5.4."></a>5.4.</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf/httpd.conf</span><br><span class="line"></span><br><span class="line">DocumentRoot &quot;/redmine/public&quot;</span><br></pre></td></tr></table></figure><h2 id="5-5-给Apache权限"><a href="#5-5-给Apache权限" class="headerlink" title="5.5. 给Apache权限"></a>5.5. 给Apache权限</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R apache:apache /redmine</span><br></pre></td></tr></table></figure><h2 id="5-6-重启Apache"><a href="#5-6-重启Apache" class="headerlink" title="5.6. 重启Apache"></a>5.6. 重启Apache</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable httpd</span><br><span class="line">systemctl start httpd</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="6-防火墙"><a href="#6-防火墙" class="headerlink" title="6. 防火墙"></a>6. 防火墙</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --permanent --add-service=http</span><br><span class="line">firewall-cmd --zone=public --permanent --add-service=https</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><h1 id="7-排错"><a href="#7-排错" class="headerlink" title="7. 排错"></a>7. 排错</h1><h2 id="7-1-删除PostgreSQL数据库以及用户"><a href="#7-1-删除PostgreSQL数据库以及用户" class="headerlink" title="7.1. 删除PostgreSQL数据库以及用户"></a>7.1. 删除PostgreSQL数据库以及用户</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# su - postgres</span><br><span class="line">[postgres@localhost ~]$ psql</span><br><span class="line">drop database redmine;</span><br><span class="line">drop role redmine;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\du #查看用户</span><br><span class="line">\l #查看数据库</span><br><span class="line">\q #退出</span><br></pre></td></tr></table></figure><blockquote><p>参考：<br><a href="https://www.redmine.org/projects/redmine/wiki/redmineinstall">Redmine官方安装教程</a><br><a href="https://chiritsumon.net/contents/archives/2072">CentOS8にRedmine4.1をインストールする</a><br><a href="https://cloud.tencent.com/developer/article/1626834">如何在 CentOS 8 上安装 Postgresql</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0-环境说明&quot;&gt;&lt;a href=&quot;#0-环境说明&quot; class=&quot;headerlink&quot; title=&quot;0. 环境说明&quot;&gt;&lt;/a&gt;0. 环境说明&lt;/h1&gt;&lt;h3 id=&quot;Redmine需要的环境：&quot;&gt;&lt;a href=&quot;#Redmine需要的环境：&quot; class=&quot;</summary>
      
    
    
    
    <category term="Redmine" scheme="https://kenryu.cc/categories/Redmine/"/>
    
    
  </entry>
  
  <entry>
    <title>Redmine搭建（MySQL+Apache版）</title>
    <link href="https://kenryu.cc/2021/10/26/Redmine/Redmine%E6%90%AD%E5%BB%BA%EF%BC%88MySQL_Apache%E7%89%88%EF%BC%89/"/>
    <id>https://kenryu.cc/2021/10/26/Redmine/Redmine%E6%90%AD%E5%BB%BA%EF%BC%88MySQL_Apache%E7%89%88%EF%BC%89/</id>
    <published>2021-10-26T06:42:55.000Z</published>
    <updated>2022-06-30T00:45:55.820Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0-环境说明"><a href="#0-环境说明" class="headerlink" title="0. 环境说明"></a>0. 环境说明</h1><h3 id="Redmine需要的环境："><a href="#Redmine需要的环境：" class="headerlink" title="Redmine需要的环境："></a>Redmine需要的环境：</h3><ul><li>能运行Ruby的OS</li><li>数据库（MySQL &#x2F; PostgreSQL &#x2F; SQLite &#x2F; SQL服务器）</li><li>网站服务（Apache &#x2F; Nginx ）</li></ul><h3 id="本次搭建环境："><a href="#本次搭建环境：" class="headerlink" title="本次搭建环境："></a>本次搭建环境：</h3><table><thead><tr><th>Software</th><th>Version</th><th>Command</th></tr></thead><tbody><tr><td>OS</td><td>CentOS Linux release 8.4.2105</td><td>cat &#x2F;etc&#x2F;os-release &#x2F;etc&#x2F;redhat-release &#x2F;etc&#x2F;system-release</td></tr><tr><td>Redmine</td><td>4.2.3</td><td></td></tr><tr><td>MySQL</td><td>Ver 14.14 Distrib 5.7.36, for Linux (x86_64) using EditLine wrapper</td><td>mysql –version</td></tr><tr><td>MySQL</td><td>mysql Ver 8.0.26 for Linux on x86_64 (Source distribution)</td><td>mysql –version</td></tr><tr><td>Ruby</td><td>ruby 2.5.9p229 (2021-04-05 revision 67939) [x86_64-linux]</td><td>ruby -v</td></tr><tr><td>Apache</td><td>Apache&#x2F;2.4.37 (centos)</td><td>apachectl -v</td></tr></tbody></table><h1 id="1-下载需要的软件包"><a href="#1-下载需要的软件包" class="headerlink" title="1. 下载需要的软件包"></a>1. 下载需要的软件包</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dnf -y update</span><br><span class="line">dnf -y groupinstall &quot;Development Tools&quot;</span><br><span class="line">dnf -y install vim wget tar openssl* httpd httpd-devel ruby ruby-devel libcurl-devel</span><br></pre></td></tr></table></figure><h1 id="2-安装数据库"><a href="#2-安装数据库" class="headerlink" title="2. 安装数据库"></a>2. 安装数据库</h1><h2 id="（选项1）2-1-安装最新版的Mysql数据库（8-0-26）"><a href="#（选项1）2-1-安装最新版的Mysql数据库（8-0-26）" class="headerlink" title="（选项1）2.1. 安装最新版的Mysql数据库（8.0.26）"></a>（选项1）2.1. 安装最新版的Mysql数据库（8.0.26）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf -y install mysql-server mysql-devel</span><br></pre></td></tr></table></figure><h2 id="（选项2）2-2-安装旧版的Mysql数据库（5-7-36）"><a href="#（选项2）2-2-安装旧版的Mysql数据库（5-7-36）" class="headerlink" title="（选项2）2.2. 安装旧版的Mysql数据库（5.7.36）"></a>（选项2）2.2. 安装旧版的Mysql数据库（5.7.36）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget http://dev.mysql.com/get/mysql57-community-release-el7-8.noarch.rpm</span><br><span class="line">yum localinstall mysql57-community-release-el7-8.noarch.rpm</span><br><span class="line">yum repolist enabled | grep &quot;mysql.*-community.*&quot;</span><br><span class="line">yum module disable mysql</span><br><span class="line">yum install mysql-community-server -y</span><br><span class="line">systemctl enable mysqld</span><br><span class="line">systemctl start mysqld</span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="（选项3）2-3-安装旧版的Mysql数据库（5-7-36）"><a href="#（选项3）2-3-安装旧版的Mysql数据库（5-7-36）" class="headerlink" title="（选项3）2.3. 安装旧版的Mysql数据库（5.7.36）"></a>（选项3）2.3. 安装旧版的Mysql数据库（5.7.36）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">rpm -ivh mysql80-community-release-el7-3.noarch.rpm</span><br></pre></td></tr></table></figure><p>指定版本 (5.7)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/yum.repos.d/</span><br><span class="line">vim mysql-community.repo</span><br></pre></td></tr></table></figure><p><img src="/resources/67010a66a22e48c5b133de6df277264d.png" alt="a8f7e14be6eda3ea928d1df2a0f7f0b6.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y module disable mysql</span><br><span class="line">yum -y install mysql-community-server</span><br></pre></td></tr></table></figure><p>确认</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql --version</span><br></pre></td></tr></table></figure><h2 id="（选项4）2-4-获取数据库初始密码"><a href="#（选项4）2-4-获取数据库初始密码" class="headerlink" title="（选项4）2.4. 获取数据库初始密码"></a>（选项4）2.4. 获取数据库初始密码</h2><p>（旧版数据库需要）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &#x27;temporary password&#x27; /var/log/mysqld.log</span><br></pre></td></tr></table></figure><h2 id="2-5-配置数据库"><a href="#2-5-配置数据库" class="headerlink" title="2.5. 配置数据库"></a>2.5. 配置数据库</h2><p>初始化数据库，根据需求选择 Y &#x2F; N</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure><p>为Redmine创建数据库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line">CREATE DATABASE redmine CHARACTER SET utf8mb4;</span><br><span class="line">set global validate_password.policy=0; #密码策略为0这一步可选</span><br><span class="line">CREATE USER &#x27;redmine&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;my_password&#x27;; #把&#x27;my_password&#x27;改为我们想要设定的密码</span><br><span class="line">GRANT ALL PRIVILEGES ON redmine.* TO &#x27;redmine&#x27;@&#x27;localhost&#x27;;</span><br></pre></td></tr></table></figure><p>重启数据库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable mysqld</span><br><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure><h1 id="3-关闭Selinux"><a href="#3-关闭Selinux" class="headerlink" title="3. 关闭Selinux"></a>3. 关闭Selinux</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/selinux/config</span><br><span class="line">#SELINUX=enforcing</span><br><span class="line"></span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br><span class="line">getenforce # 确认结果</span><br></pre></td></tr></table></figure><h1 id="4-下载安装Redmine"><a href="#4-下载安装Redmine" class="headerlink" title="4. 下载安装Redmine"></a>4. 下载安装Redmine</h1><blockquote><p>获取最新版本:<br><a href="https://www.redmine.org/projects/redmine/wiki/Download">Redmine官方下载地址</a></p></blockquote><h2 id="4-1-下载以及解压"><a href="#4-1-下载以及解压" class="headerlink" title="4.1. 下载以及解压"></a>4.1. 下载以及解压</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.redmine.org/releases/redmine-4.2.3.tar.gz</span><br><span class="line">tar -zxvf redmine-4.2.3.tar.gz</span><br><span class="line">mv redmine-4.2.3 /redmine</span><br></pre></td></tr></table></figure><h2 id="4-2-配置database-yml文件"><a href="#4-2-配置database-yml文件" class="headerlink" title="4.2. 配置database.yml文件"></a>4.2. 配置database.yml文件</h2><p>根据数据库设置，配置Redmine的连接数据库设定文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cd /redmine/config/</span><br><span class="line">cp database.yml.example database.yml</span><br><span class="line">vim database.yml</span><br><span class="line"></span><br><span class="line">production:</span><br><span class="line">adapter: mysql2</span><br><span class="line">database: redmine</span><br><span class="line">host: localhost</span><br><span class="line">username: redmine</span><br><span class="line">password: &quot;my_password&quot;</span><br><span class="line"># Use &quot;utf8&quot; instead of &quot;utfmb4&quot; for MySQL prior to 5.7.7</span><br><span class="line">encoding: utf8mb4</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>注意：<br>要把development，test等区域给删了<br>排版缩进要正确！</p></blockquote><h2 id="4-3-通过Ruby部署"><a href="#4-3-通过Ruby部署" class="headerlink" title="4.3. 通过Ruby部署"></a>4.3. 通过Ruby部署</h2><p>我对Ruby不了解，这些命令不是很懂，似乎可以自动导入 Redmine 操作所需的 Ruby 软件包，为 MySQL 数据库创建所需的表或加载默认数据？注意不能忘了，在执行操作前移动到Redmine目录。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /redmine</span><br><span class="line">gem install bundler</span><br><span class="line">bundle install --without development test rmagick</span><br><span class="line">bundle exec rake generate_secret_token</span><br><span class="line">RAILS_ENV=production bundle exec rake db:migrate</span><br><span class="line">RAILS_ENV=production bundle exec rake redmine:load_default_data</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>执行最后一行的时候选择想要的语言。</p><h1 id="5-配置Apache"><a href="#5-配置Apache" class="headerlink" title="5. 配置Apache"></a>5. 配置Apache</h1><h2 id="5-1-安装passenger"><a href="#5-1-安装passenger" class="headerlink" title="5.1. 安装passenger"></a>5.1. 安装passenger</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gem install passenger</span><br><span class="line">passenger-install-apache2-module --auto --languages ruby</span><br></pre></td></tr></table></figure><p>有大量的日志在画面上滚动，需要花一点时间。虽然有很多警告，但是如果不因错误而掉落的话应该没什么问题。</p><h2 id="5-2-安装snippet"><a href="#5-2-安装snippet" class="headerlink" title="5.2. 安装snippet"></a>5.2. 安装snippet</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redmine]# passenger-install-apache2-module --snippet</span><br><span class="line">LoadModule passenger_module /usr/local/share/gems/gems/passenger-6.0.11/buildout/apache2/mod_passenger.so</span><br><span class="line">&lt;IfModule mod_passenger.c&gt;</span><br><span class="line">PassengerRoot /usr/local/share/gems/gems/passenger-6.0.11</span><br><span class="line">PassengerDefaultRuby /usr/bin/ruby</span><br><span class="line">&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure><h2 id="5-3-设置Redmine为Apache的根目录，并把上一步5-2的结果复制下来粘贴到redmine-conf文件中"><a href="#5-3-设置Redmine为Apache的根目录，并把上一步5-2的结果复制下来粘贴到redmine-conf文件中" class="headerlink" title="5.3. 设置Redmine为Apache的根目录，并把上一步5.2的结果复制下来粘贴到redmine.conf文件中"></a>5.3. 设置Redmine为Apache的根目录，并把上一步5.2的结果复制下来粘贴到redmine.conf文件中</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf.d/redmine.conf</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/redmine/public&quot;&gt;</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">LoadModule passenger_module /usr/local/share/gems/gems/passenger-6.0.11/buildout/apache2/mod_passenger.so</span><br><span class="line">&lt;IfModule mod_passenger.c&gt;</span><br><span class="line">PassengerRoot /usr/local/share/gems/gems/passenger-6.0.11</span><br><span class="line">PassengerDefaultRuby /usr/bin/ruby</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="5-4"><a href="#5-4" class="headerlink" title="5.4."></a>5.4.</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf/httpd.conf</span><br><span class="line"></span><br><span class="line">DocumentRoot &quot;/redmine/public&quot;</span><br></pre></td></tr></table></figure><h2 id="5-5-给Apache权限"><a href="#5-5-给Apache权限" class="headerlink" title="5.5. 给Apache权限"></a>5.5. 给Apache权限</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R apache:apache /redmine</span><br></pre></td></tr></table></figure><h2 id="5-6-重启Apache"><a href="#5-6-重启Apache" class="headerlink" title="5.6. 重启Apache"></a>5.6. 重启Apache</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable httpd</span><br><span class="line">systemctl start httpd</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="6-防火墙"><a href="#6-防火墙" class="headerlink" title="6. 防火墙"></a>6. 防火墙</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --permanent --add-service=http</span><br><span class="line">firewall-cmd --zone=public --permanent --add-service=https</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><h1 id="7-排错"><a href="#7-排错" class="headerlink" title="7. 排错"></a>7. 排错</h1><h2 id="7-1-删除Mysql数据库"><a href="#7-1-删除Mysql数据库" class="headerlink" title="7.1. 删除Mysql数据库"></a>7.1. 删除Mysql数据库</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf -y remove mysql mysql-server mysql-libs mysql-common</span><br><span class="line">rm -rf /var/lib/mysql</span><br></pre></td></tr></table></figure><blockquote><p>参考：<br><a href="https://www.redmine.org/projects/redmine/wiki/redmineinstall">Redmine官方安装教程</a><br><a href="https://chiritsumon.net/contents/archives/2072">CentOS8にRedmine4.1をインストールする</a></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# sudo su - postgres</span><br><span class="line">[postgres@localhost ~]$ psql</span><br></pre></td></tr></table></figure><pre><code>CREATE ROLE redmine LOGIN ENCRYPTED PASSWORD &#39;Your_Password&#39; NOINHERIT VALID UNTIL &#39;infinity&#39;;CREATE DATABASE redmine WITH ENCODING=&#39;UTF8&#39; OWNER=redmine;</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0-环境说明&quot;&gt;&lt;a href=&quot;#0-环境说明&quot; class=&quot;headerlink&quot; title=&quot;0. 环境说明&quot;&gt;&lt;/a&gt;0. 环境说明&lt;/h1&gt;&lt;h3 id=&quot;Redmine需要的环境：&quot;&gt;&lt;a href=&quot;#Redmine需要的环境：&quot; class=&quot;</summary>
      
    
    
    
    <category term="Redmine" scheme="https://kenryu.cc/categories/Redmine/"/>
    
    
  </entry>
  
  <entry>
    <title>PCI pass though (Ethernet port)</title>
    <link href="https://kenryu.cc/2021/08/26/Virtualization/PCI_pass_though_(Ethernet_port)/"/>
    <id>https://kenryu.cc/2021/08/26/Virtualization/PCI_pass_though_(Ethernet_port)/</id>
    <published>2021-08-26T06:51:28.000Z</published>
    <updated>2022-07-01T05:03:47.449Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig</span><br></pre></td></tr></table></figure><p><img src="/resources/1b17f06e0c5e4b5f874e8d75f202e0a3.png" alt="58d2fbc072f3f7bf1ce2a499b5351171.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@SMC-KVM ~]# ethtool -i eno2</span><br><span class="line">driver: ixgbe</span><br><span class="line">version: 4.18.0-305.10.2.el8_4.x86_64</span><br><span class="line">firmware-version: 0x800007f6, 1.1747.0</span><br><span class="line">expansion-rom-version:</span><br><span class="line">bus-info: 0000:01:00.1</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: yes</span><br><span class="line">supports-register-dump: yes</span><br><span class="line">supports-priv-flags: yes</span><br></pre></td></tr></table></figure><p><img src="/resources/27aace41d26041b79a0f5d80136e96e9.png" alt="3211af94caf301c7b3f8e2c6733a0a41.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/grub2-efi.cfg</span><br><span class="line"># vim /etc/grub2.cfg</span><br><span class="line">set kernelopts=&quot;...iommu.passthrough=1&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/resources/98a5588d33c6466885873b358a593124.png" alt="9ab23b9c1a1cf4a1a7c3112cf9b149c7.png"></p><p>Enable intel iommu:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/default/grub</span><br><span class="line"></span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;... intel_iommu=on iommu=pt</span><br><span class="line">#GRUB_CMDLINE_LINUX=&quot; ... amd_iommu=on</span><br></pre></td></tr></table></figure><blockquote><p>If intel_iommu&#x3D;on or amd_iommu&#x3D;on works, you can try replacing them with iommu&#x3D;pt or amd_iommu&#x3D;pt.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line">cat /etc/grub2.cfg | grep &#x27;set kernelopt&#x27; # 这时候上面的设置已经被映射过来了</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dmesg | grep IOMMU</span><br></pre></td></tr></table></figure><p><img src="/resources/ccce25e9c35147de801cf73e4dad14bd.png" alt="c7a7c4f84766890e7a208a172e89536f.png"></p><p>Modify VM’s specification:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/libvirt/qemu/cjl-test.xml /etc/libvirt/qemu/cjl-test.xml.bak</span><br><span class="line">vim /etc/libvirt/qemu/cjl-test.xml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;hostdev mode=&#x27;subsystem&#x27; type=&#x27;pci&#x27; managed=&#x27;yes&#x27;&gt;</span><br><span class="line">&lt;source&gt;</span><br><span class="line">&lt;address domain=&#x27;0x0000&#x27; bus=&#x27;0x01&#x27; slot=&#x27;0x00&#x27; function=&#x27;0x1&#x27;/&gt;</span><br><span class="line">&lt;/source&gt;</span><br><span class="line">##&lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x01&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">&lt;/hostdev&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/resources/8bef6e49dd35419e87752e04ca76910f.png" alt="b78244be8645b79ac8943a0048b30856.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh define &amp;VMname</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ethtool -i eno2</span><br><span class="line">ethtool -i eno1</span><br></pre></td></tr></table></figure><h1 id="Guest-VM"><a href="#Guest-VM" class="headerlink" title="Guest (VM)"></a>Guest (VM)</h1><p><img src="/resources/908b43347b8f434da7ed603cdabb2206.png" alt="287e347b89b51b80dd46d4a9d1e9651c.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# lspci | grep Ethernet</span><br><span class="line">00:02.0 Ethernet controller: Intel Corporation Ethernet Controller 10G X550T (rev 01)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ethtool -i ens2</span><br><span class="line">driver: ixgbe</span><br><span class="line">version: 4.18.0-305.10.2.el8_4.x86_64</span><br><span class="line">firmware-version: 0x800007f6, 1.1747.0</span><br><span class="line">expansion-rom-version:</span><br><span class="line">bus-info: 0000:00:02.0</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: yes</span><br><span class="line">supports-register-dump: yes</span><br><span class="line">supports-priv-flags: yes</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span</summary>
      
    
    
    
    <category term="Virtualization" scheme="https://kenryu.cc/categories/Virtualization/"/>
    
    
    <category term="kvm" scheme="https://kenryu.cc/tags/kvm/"/>
    
    <category term="hypervisor" scheme="https://kenryu.cc/tags/hypervisor/"/>
    
  </entry>
  
  <entry>
    <title>Setup NFS client (nfs-utils)</title>
    <link href="https://kenryu.cc/2021/05/11/File_Sharing_Servers/Setup_NFS_client__nfs_utils_/"/>
    <id>https://kenryu.cc/2021/05/11/File_Sharing_Servers/Setup_NFS_client__nfs_utils_/</id>
    <published>2021-05-11T06:01:24.000Z</published>
    <updated>2022-06-30T00:45:55.810Z</updated>
    
    <content type="html"><![CDATA[<p>nfs客户端通过mount实现连接服务器</p><p>下载安装nfs-utils</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install nfs-utils</span><br></pre></td></tr></table></figure><p>确认</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@client ~]# showmount -e 192.168.64.48</span><br><span class="line">Export list for 192.168.64.48:</span><br><span class="line">/tmp/nfs 192.168.64.0/22</span><br></pre></td></tr></table></figure><p>挂载锚点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs 192.168.64.48:/tmp/nfs /mnt</span><br><span class="line"></span><br><span class="line">df -hT</span><br></pre></td></tr></table></figure><h2 id="Automatically-mount-by-using-autofs"><a href="#Automatically-mount-by-using-autofs" class="headerlink" title="Automatically mount by using autofs"></a>Automatically mount by using <strong>autofs</strong></h2><blockquote><p>One drawback of using &#x2F;etc&#x2F;fstab is that, regardless of how infrequently a user accesses the NFS mounted file system, the system must dedicate resources to keep the mounted file system in place. This is not a problem with one or two mounts, but when the system is maintaining mounts to many systems at one time, overall system performance can be affected.<br><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/nfs-autofs">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/nfs-autofs</a></p></blockquote><p>Step1. Install <strong>autofs</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf -y install autofs</span><br><span class="line">systemctl enable autofs</span><br></pre></td></tr></table></figure><p>Step2. Edit auto.master for direct mapping</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/auto.master</span><br><span class="line">#/misc /etc/auto.misc</span><br><span class="line">/- /etc/auto.misc</span><br></pre></td></tr></table></figure><p>Step3. Edit auto.misc</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/auto.misc</span><br><span class="line">/share -fstype=nfs4,rw 192.168.65.129:/share</span><br></pre></td></tr></table></figure><p>Step4. Restart autofs to apply the changes</p><pre><code>systemctl restart autofs</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;nfs客户端通过mount实现连接服务器&lt;/p&gt;
&lt;p&gt;下载安装nfs-utils&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/sp</summary>
      
    
    
    
    <category term="File Sharing Servers" scheme="https://kenryu.cc/categories/File-Sharing-Servers/"/>
    
    
  </entry>
  
  <entry>
    <title>Setup NFS server (nfs-utils)</title>
    <link href="https://kenryu.cc/2021/05/11/File_Sharing_Servers/Setup_NFS_server__nfs_utils_/"/>
    <id>https://kenryu.cc/2021/05/11/File_Sharing_Servers/Setup_NFS_server__nfs_utils_/</id>
    <published>2021-05-11T05:06:04.000Z</published>
    <updated>2022-06-30T00:45:55.810Z</updated>
    
    <content type="html"><![CDATA[<p>Socket Statisticsの確認</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost html]# ss -ntul</span><br><span class="line">Netid State Recv-Q Send-Q Local Address:Port Peer Address:Port</span><br><span class="line">tcp LISTEN 0 128 0.0.0.0:22 0.0.0.0:*</span><br><span class="line">tcp LISTEN 0 128 [::]:22 [::]:*</span><br></pre></td></tr></table></figure><p>安装nfs-utils</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install nfs-utils</span><br></pre></td></tr></table></figure><p>设置防火墙</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --permanent --add-service=&#123;rpc-bind,mountd,nfs&#125;</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">firewall-cmd --list-all</span><br></pre></td></tr></table></figure><p>设置开机自启</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable rpcbind</span><br><span class="line">systemctl enable nfs-server.service</span><br></pre></td></tr></table></figure><p>设置配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nfs]# vi /etc/exports</span><br><span class="line">/tmp/nfs/ 192.168.64.0/22(rw,sync,no_root_squash,no_all_squash)</span><br></pre></td></tr></table></figure><p>配置文件的参数</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>ro</td><td>只读</td></tr><tr><td>rw</td><td>读写</td></tr><tr><td>root_squash</td><td>当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户</td></tr><tr><td>no_root_squash</td><td>当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员</td></tr><tr><td>all_squash</td><td>无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户</td></tr><tr><td>sync</td><td>同时将数据写入到内存与硬盘中，保证不丢失数据</td></tr><tr><td>async</td><td>优先将数据写入到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据</td></tr><tr><td>anonuid</td><td>指定uid的值，此uid必须存在于&#x2F;etc&#x2F;passwd中</td></tr><tr><td>anongid</td><td>指定gid的值</td></tr></tbody></table><p>启动nfs服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart rpcbind nfs-server.service</span><br></pre></td></tr></table></figure><p>确认</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 mnt]# ss -ntul</span><br><span class="line">Netid State Recv-Q Send-Q Local Address:Port Peer Address:Port</span><br><span class="line">udp UNCONN 0 0 0.0.0.0:111 0.0.0.0:*</span><br><span class="line">udp UNCONN 0 0 [::]:111 [::]:*</span><br><span class="line">tcp LISTEN 0 128 0.0.0.0:111 0.0.0.0:*</span><br><span class="line">tcp LISTEN 0 128 0.0.0.0:22 0.0.0.0:*</span><br><span class="line">tcp LISTEN 0 128 [::]:111 [::]:*</span><br><span class="line">tcp LISTEN 0 128 [::]:22 [::]:*</span><br><span class="line"></span><br><span class="line">[root@localhost tmp]# showmount -e localhost</span><br><span class="line">Export list for localhost:</span><br><span class="line">/tmp/nfs 192.168.64.0/22</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Socket Statisticsの確認&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;l</summary>
      
    
    
    
    <category term="File Sharing Servers" scheme="https://kenryu.cc/categories/File-Sharing-Servers/"/>
    
    
  </entry>
  
  <entry>
    <title>Setup SMB server (samba)</title>
    <link href="https://kenryu.cc/2021/05/10/File_Sharing_Servers/Setup_SMB_server__samba_/"/>
    <id>https://kenryu.cc/2021/05/10/File_Sharing_Servers/Setup_SMB_server__samba_/</id>
    <published>2021-05-10T08:16:45.000Z</published>
    <updated>2022-06-30T00:45:55.810Z</updated>
    
    <content type="html"><![CDATA[<p>Socket Statisticsの確認</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost html]# ss -ntul</span><br><span class="line">Netid State Recv-Q Send-Q Local Address:Port Peer Address:Port</span><br><span class="line">tcp LISTEN 0 128 0.0.0.0:22 0.0.0.0:*</span><br><span class="line">tcp LISTEN 0 128 [::]:22 [::]:*</span><br></pre></td></tr></table></figure><p>smb serverをインストール、FWの設定</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">yum install samba</span><br><span class="line">firewall-cmd --zone=public --add-service=samba --permanent</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">[root@localhost ~]# firewall-cmd --list-all</span><br><span class="line">public (active)</span><br><span class="line">target: default</span><br><span class="line">icmp-block-inversion: no</span><br><span class="line">interfaces: enp0s3</span><br><span class="line">sources:</span><br><span class="line">services: cockpit dhcpv6-client ftp http samba ssh</span><br><span class="line">ports:</span><br><span class="line">protocols:</span><br><span class="line">masquerade: no</span><br><span class="line">forward-ports:</span><br><span class="line">source-ports:</span><br><span class="line">icmp-blocks:</span><br><span class="line">rich rules:</span><br></pre></td></tr></table></figure><p>修改配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/samba/smb.conf /etc/samba/smb.conf.bak t#备份配置文件</span><br><span class="line">vim /etc/samba/smb.conftttt#编辑内容</span><br></pre></td></tr></table></figure><p>vim编辑里面修改或者添加以下内容</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改global全局配置</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">samba4较之前的samba3有一个重大的变化是：security不再支持share</span></span><br><span class="line">[global]</span><br><span class="line">workgroup = WORKGROUP</span><br><span class="line">security=user</span><br><span class="line">map to guest =Bad User</span><br><span class="line">tt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加名为share的共享文件夹</span></span><br><span class="line">[share]</span><br><span class="line">comment = share all</span><br><span class="line">path = /tmp/samba</span><br><span class="line">browseable = yes</span><br><span class="line">public = yes</span><br><span class="line">writable = yes</span><br><span class="line">create mode = 0755</span><br><span class="line">force create mode = 0755</span><br><span class="line">directory mode = 0755</span><br><span class="line">force directory mode = 0755</span><br><span class="line">force user = apache</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>检测语法是否错误</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# testparm</span><br><span class="line">Load smb config files from /etc/samba/smb.conf</span><br><span class="line">Loaded services file OK.</span><br><span class="line">Server role: ROLE_STANDALONE</span><br><span class="line"></span><br><span class="line">Press enter to see a dump of your service definitions</span><br></pre></td></tr></table></figure><p>创建一个共享文件夹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tmp/samba</span><br><span class="line">chmod 777 /tmp/samba</span><br><span class="line">touch /tmp/samba/sharefiles</span><br><span class="line">echo &quot;111111&quot; &gt; /tmp/samba/sharefiles</span><br></pre></td></tr></table></figure><p>启动smb服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl start smb</span><br></pre></td></tr></table></figure><p>确认smb版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbstatus --version</span><br></pre></td></tr></table></figure><p>通过Socket Statistics可以看到139, 445端口已经被打开</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ss -tunl</span><br><span class="line">Netid State Recv-Q Send-Q Local Address:Port Peer Address:Port</span><br><span class="line">tcp LISTEN 0 50 0.0.0.0:139 0.0.0.0:*</span><br><span class="line">tcp LISTEN 0 128 0.0.0.0:22 0.0.0.0:*</span><br><span class="line">tcp LISTEN 0 50 0.0.0.0:445 0.0.0.0:*</span><br><span class="line">tcp LISTEN 0 50 [::]:139 [::]:*</span><br><span class="line">tcp LISTEN 0 128 [::]:22 [::]:*</span><br><span class="line">tcp LISTEN 0 50 [::]:445 [::]:*</span><br></pre></td></tr></table></figure><p>此时防火墙是打开的状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl status firewalld</span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)</span><br><span class="line">Active: active (running) since Tue 2021-05-11 09:40:50 JST; 37min ago</span><br><span class="line">Docs: man:firewalld(1)</span><br><span class="line">Main PID: 857 (firewalld)</span><br><span class="line">Tasks: 2 (limit: 12404)</span><br><span class="line">Memory: 36.5M</span><br><span class="line">CGroup: /system.slice/firewalld.service</span><br><span class="line">mq857 /usr/libexec/platform-python -s /usr/sbin/firewalld --nofork --nopid</span><br><span class="line"></span><br><span class="line">May 11 09:40:49 localhost.localdomain systemd[1]: Starting firewalld - dynamic firewall daemon...</span><br><span class="line">May 11 09:40:50 localhost.localdomain systemd[1]: Started firewalld - dynamic firewall daemon.</span><br><span class="line">May 11 09:40:51 localhost.localdomain firewalld[857]: WARNING: AllowZoneDrifting is enabled. This is considered an insecure configuration option. It w&gt;</span><br></pre></td></tr></table></figure><p>关于SELinux</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# getenforce</span><br><span class="line"><span class="meta prompt_">Enforcingttt#</span><span class="language-bash">强制执行</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这种状态不可访问</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# getenforce</span><br><span class="line"><span class="meta prompt_">Permissivettt#</span><span class="language-bash">许可的</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这种状态只有只读权限</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">SELINUX=enforcingtt<span class="comment">#强制执行</span></span></span><br><span class="line">SELINUX=disabledtt#关闭</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# reboott#需要重启</span><br><span class="line">[root@localhost ~]# getenforce</span><br><span class="line">disabled</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这种状态只有只读权限</span></span><br></pre></td></tr></table></figure><p>在win10下打开服务器地址</p><pre><code></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Socket Statisticsの確認&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;l</summary>
      
    
    
    
    <category term="File Sharing Servers" scheme="https://kenryu.cc/categories/File-Sharing-Servers/"/>
    
    
  </entry>
  
  <entry>
    <title>Setup FTP server (vsftpd)</title>
    <link href="https://kenryu.cc/2021/05/10/File_Sharing_Servers/Setup_FTP_server__vsftpd_/"/>
    <id>https://kenryu.cc/2021/05/10/File_Sharing_Servers/Setup_FTP_server__vsftpd_/</id>
    <published>2021-05-10T01:44:49.000Z</published>
    <updated>2022-06-30T00:45:55.810Z</updated>
    
    <content type="html"><![CDATA[<p>Socket Statistics</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost html]# ss -ntul</span><br><span class="line">Netid State Recv-Q Send-Q Local Address:Port Peer Address:Port</span><br><span class="line">tcp LISTEN 0 128 0.0.0.0:22 0.0.0.0:*</span><br><span class="line">tcp LISTEN 0 128 [::]:22 [::]:*</span><br></pre></td></tr></table></figure><p>FTP server pakege install</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install vsftpd -y</span><br></pre></td></tr></table></figure><p>FW setting</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-service=ftp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><p>必须设置selinux为关闭</p><ol><li>临时设置（重启失效）<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]# setenforce 0</span><br><span class="line">[root@centos8 ~]# getenforce</span><br><span class="line">Permissive</span><br></pre></td></tr></table></figure></li><li>永久设置<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]# vim /etc/selinux/config</span><br><span class="line">#SELINUX=enforcing</span><br><span class="line">SELINUX=disabled</span><br><span class="line">[root@centos8 ~]# reboot</span><br><span class="line">[root@centos8 ~]# getenforce</span><br><span class="line">Disabled</span><br></pre></td></tr></table></figure></li></ol><p>FTP的配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ls /etc/vsftpd/</span><br><span class="line">ftpusers user_list vsftpd.conf vsftpd_conf_migrate.sh</span><br></pre></td></tr></table></figure><p>备份主配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/vsftpd/vsftpd.conf /etc/vsftpd/vsftpd.conf.bak</span><br></pre></td></tr></table></figure><p>FTP可以有三种登入方式分别是：</p><blockquote><p>匿名登录方式：不需要用户密码<br>本地用户登入：使用本地用户和密码登入<br>虚拟用户方式：也是使用用户和密码登入，但是该用户不是linux中创建的用户<br>vsftpd.conf: 主配置文件</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]# vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">anonymous_enable=YEStt#允许匿名用户登陆</span><br><span class="line">anon_upload_enable=YES tt#匿名用户可以上传文件</span><br><span class="line">anon_mkdir_write_enable=YESt#匿名用户可以修改文件夹</span><br><span class="line">anon_other_write_enable=YESt#匿名用户可以修改文件夹</span><br><span class="line">no_anon_password=YEStt#匿名用户login时不询问口令</span><br><span class="line">anon_umask=011tt#匿名用户创建文件的掩码，不指定时候为077</span><br><span class="line"></span><br><span class="line">local_enable=YES #vsftpd所在系统的用户可以登录vsftpd</span><br><span class="line">write_enable=YES #全局设置，是否容许写入（无论是匿名用户还是本地用户，若要启用上传权限的话，就要开启他）</span><br><span class="line">local_umask=002 #匿名用户新增文件的umask数值</span><br><span class="line">xferlog_enable=YES #启用一个日志文件，用于详细记录上传和下载。</span><br><span class="line">use_localtime=YES #使用本地时间而不是GMT</span><br><span class="line">vsftpd_log_file=/var/log/vsftpd.log #vsftpd日志存放位置</span><br><span class="line">dual_log_enable=YES #用户登陆日志</span><br><span class="line">connect_from_port_20=YES #开启20端口</span><br><span class="line">xferlog_file=/var/log/xferlog #记录上传下载文件的日志</span><br><span class="line">xferlog_std_format=YES #记录日志使用标准格式</span><br><span class="line">idle_session_timeout=600 #登陆之后超时时间60秒，登陆之后，一分钟不操作，就会断开连接。</span><br><span class="line">chroot_local_user=YES #用于指定用户列表文件中的用户,是否允许切换到上级目录</span><br><span class="line">listen=YES #开启监听</span><br><span class="line">pam_service_name=vsftpd.vu #验证文件的名字</span><br><span class="line">userlist_enable=YES #允许由user_list指定文件中的用户登录FTP服务器</span><br><span class="line">tcp_wrappers=YES #支持tcp_wrappers,限制访问(/etc/hosts.allow,/etc/hosts.deny)</span><br><span class="line">guest_enable=YES #起用虚拟用户</span><br><span class="line">guest_username=taokey #虚拟用户名</span><br><span class="line"></span><br><span class="line">#user_config_dir=/etc/vsftpd/vsftpuser #虚拟用户配置文件路径</span><br><span class="line">local_root=/home/ftpUser/ #自定义ftp上传路径（注意文件夹权限）</span><br><span class="line">pasv_min_port=35000</span><br><span class="line">pasv_max_port=45000</span><br><span class="line">pasv_enable=YES</span><br><span class="line">pasv_promiscuous=YES</span><br><span class="line">anon_other_write_enable=YES</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># 1. 监听相关</span><br><span class="line">#</span><br><span class="line">listen=&lt;YES/NO&gt; # YES: 服务以独立运行方式运行; NO: 运行在 xinetd 内。 默认为 YES</span><br><span class="line">listen_address=&lt;ip address&gt; # 服务监听地址, 如果有多个网卡, 需要将服务绑定到指定 IP 地址</span><br><span class="line">listen_port=&lt;port&gt; # 服务监听端口, 默认为 21</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># 2. 匿名用户相关</span><br><span class="line">#</span><br><span class="line">anonymous_enable=&lt;YES/NO&gt; # 是否允许匿名用户访问, 默认 NO</span><br><span class="line">no_anon_password=YES t # 匿名用户login时不询问口令</span><br><span class="line">anon_mkdir_write_enable=&lt;YES/NO&gt; # 是否允许匿名用户创建文件夹, 默认 NO</span><br><span class="line">anon_other_write_enable=&lt;YES/NO&gt; # 是否允许匿名用户重命名、删除文件夹等其他权限（默认为 NO, 基于安全性考虑这个权限一般不打开）</span><br><span class="line">anon_upload_enable=&lt;YES/NO&gt; # 是否允许匿名用户上传, 默认 NO</span><br><span class="line">anon_umask=&lt;nnn&gt; # 匿名用户上传的文件的生成掩码, 默认为077</span><br><span class="line">anon_max_rate=&lt;n&gt; # 匿名用户的最大传输速率, 单位为 Byte/s, 值为 0 表示不限制</span><br><span class="line">anon_world_readable_only=&lt;YES/NO&gt; # 是否允许匿名用户只读浏览</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># 3. 本地用户(Linux标准系统用户)相关</span><br><span class="line">#</span><br><span class="line">local_enable=&lt;YES/NO&gt; # 是否支持本地用户帐号访问</span><br><span class="line">write_enable=&lt;YES/NO&gt; # 是否开放本地用户的写权限</span><br><span class="line">local_umask=&lt;nnn&gt; # 本地用户上传的文件的生成掩码, 默认为077</span><br><span class="line">local_max_rate=&lt;n&gt; # 本地用户最大的传输速率, 单位为 Byte/s，值为 0 表示不限制</span><br><span class="line">local_root=&lt;file&gt; # 本地用户登陆后的目录，默认为 本地用户 的 主目录</span><br><span class="line"></span><br><span class="line">chroot_local_user=&lt;YES/NO&gt; # 本地用户是否可以执行 chroot, 默认为 NO</span><br><span class="line">chroot_list_enable=&lt;YES/NO&gt; # 是否只有指定的用户才能执行 chroot, 默认为 NO</span><br><span class="line">chroot_list_file=&lt;filename&gt; # 当 chroot_local_user=NO 且 chroot_list_enable=YES 时,</span><br><span class="line"># 只有 filename 文件内指定的用户（每行一个用户名）可以执行 chroot,</span><br><span class="line"># 默认值为 /etc/vsftpd.chroot_list</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># 4. 本地用户 黑/白名单管理</span><br><span class="line">#</span><br><span class="line">userlist_enable=&lt;YES/NO&gt; # 是否启用 userlist_file 用户列表, 默认为 YES，设置为NO的时候，并且用户名不在黑名单（user_list）可以登录，并查看ls ~中的文件</span><br><span class="line"></span><br><span class="line">userlist_deny=&lt;YES/NO&gt; # 当 userlist_enable=YES（即启用 userlist_file ）时, 则该字段才有效。</span><br><span class="line"># userlist_deny=YES: userlist_file 为 黑名单, 即在该文件内的用户均不可登录, 其他用户可以登录</span><br><span class="line"># userlist_deny=NO: userlist_file 为 白名单, 即在该文件内的用户才可以登录, 其他用户均不可登录</span><br><span class="line"></span><br><span class="line">userlist_file=&lt;filename&gt; # 黑/白名单用户列表文件（每行一个用户名）,</span><br><span class="line"># 是黑名单还是白名单, 根据 userlist_deny 的值决定,</span><br><span class="line"># 默认值为 /etc/vsftpd/user_list</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># 5. 连接相关</span><br><span class="line">#</span><br><span class="line">ftpd_banner=&lt;message&gt; # 客户端连接服务器后显示的欢迎信息</span><br><span class="line">connect_timeout=&lt;n&gt; # 远程客户端响应端口数据连接超时时间, 单位为秒, 默认 60</span><br><span class="line">accept_connection_timeout=&lt;n&gt; # 空闲的数据连接超时时间, 单位为秒, 默认 120</span><br><span class="line">data_connection_timeout=&lt;n&gt; # 空闲的用户会话超时时间, 单位为秒, 默认 300</span><br><span class="line">max_clients=&lt;n&gt; # 在独立模式运行时, 最大连接数, 0 表示无限制</span><br><span class="line">max_per_ip=&lt;n&gt; # 在独立模式运行时, 每 IP 的最大连接数, 0表示无限制</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>另外默认Vsftpd匿名用户有两个：anonymous、ftp，所以匿名用户如果需要上传文件、删除及修改等权限，需要ftp用户对&#x2F;var&#x2F;ftp&#x2F;pub目录有写入权限，使用如下chown和chmod任意一种即可，设置命令如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R ftp /var/ftp/pub/</span><br><span class="line">chgrp -R ftp /var/ftp/pub/</span><br><span class="line">chmod -R 766 /var/ftp/pub/</span><br></pre></td></tr></table></figure><p>确认端口开启状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost html]# systemctl start vsftpd</span><br><span class="line">[root@localhost html]# ss -ntul</span><br><span class="line">Netid State Recv-Q Send-Q Local Address:Port Peer Address:Port</span><br><span class="line">tcp LISTEN 0 128 0.0.0.0:22 0.0.0.0:*</span><br><span class="line">tcp LISTEN 0 32 *:21 *:*</span><br><span class="line">tcp LISTEN 0 128 [::]:22 [::]:*</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Socket Statistics&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line</summary>
      
    
    
    
    <category term="File Sharing Servers" scheme="https://kenryu.cc/categories/File-Sharing-Servers/"/>
    
    
  </entry>
  
  <entry>
    <title>暗号化技術</title>
    <link href="https://kenryu.cc/2021/04/23/Security/%E6%9A%97%E5%8F%B7%E5%8C%96%E6%8A%80%E8%A1%93/"/>
    <id>https://kenryu.cc/2021/04/23/Security/%E6%9A%97%E5%8F%B7%E5%8C%96%E6%8A%80%E8%A1%93/</id>
    <published>2021-04-23T13:31:10.000Z</published>
    <updated>2022-06-30T00:45:55.820Z</updated>
    
    <content type="html"><![CDATA[<h1 id="共通鍵"><a href="#共通鍵" class="headerlink" title="共通鍵"></a>共通鍵</h1><ul><li>一对能上锁并且解锁的钥匙</li></ul><h1 id="公開鍵"><a href="#公開鍵" class="headerlink" title="公開鍵"></a>公開鍵</h1><p><img src="/resources/fc730f36a1ee42fcb1ca45576747a3c3.png" alt="4b7cd10b4d5bd3c6dca147bcc2f9aa2c.png"></p><ul><li>公开钥：谁都可以拥有，只能上锁🔒，不能开锁❌🔓</li><li>密钥：接收者自己1人拥有，能开锁🔓</li></ul><ol><li>发送者先得到接收者的公开钥</li><li>给内容上锁后发给接收者</li><li>接收者用自己的密钥开锁</li></ol><h1 id="混合式"><a href="#混合式" class="headerlink" title="混合式"></a>混合式</h1><h1 id="SSH修改公开钥匙"><a href="#SSH修改公开钥匙" class="headerlink" title="SSH修改公开钥匙"></a>SSH修改公开钥匙</h1><h2 id="MAC"><a href="#MAC" class="headerlink" title="MAC"></a>MAC</h2><h3 id="钥匙位置"><a href="#钥匙位置" class="headerlink" title="钥匙位置"></a>钥匙位置</h3><p>Offending RSA key <code>/Users/cjl/.ssh/known_hosts</code><br><img src="/resources/ed2d34c0b3b04989b0e1af213ae2a0af.png" alt="b049874d642aba982976537b47645da9.png"></p><h3 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h3><p>删除本地的钥匙,并备份旧钥匙列表<br><code>ssh-keygen -R 192.168.1.1</code></p><h3 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h3><p>手动删除本地的钥匙<br><code>vi /Users/cjl/.ssh/known_hosts</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;共通鍵&quot;&gt;&lt;a href=&quot;#共通鍵&quot; class=&quot;headerlink&quot; title=&quot;共通鍵&quot;&gt;&lt;/a&gt;共通鍵&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;一对能上锁并且解锁的钥匙&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;公開鍵&quot;&gt;&lt;a href=&quot;#公開鍵&quot; class=&quot;h</summary>
      
    
    
    
    <category term="Security" scheme="https://kenryu.cc/categories/Security/"/>
    
    
    <category term="网络" scheme="https://kenryu.cc/tags/%E7%BD%91%E7%BB%9C/"/>
    
    <category term="技术" scheme="https://kenryu.cc/tags/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
</feed>
